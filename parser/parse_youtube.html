<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=320,initial-scale=1.0"/>


<meta http-equiv="cache-control" content="max-age=0" />
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="expires" content="0" />
<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
<meta http-equiv="pragma" content="no-cache" />

	
	<title>parse youtube playlists</title>
	<link rel="stylesheet" href="css/bootstrap.css"/>	
	<link rel="stylesheet" href="css/bootstrap-responsive.css"/>
	<script type="text/javascript" src="js/lib/jquery.min.js"></script>

<script>
$(document).ready(
function()
{
	parse_xml('xml/youtube_playlists.xml');

//-------------------------- read templates	
	var sub_entry_tpl = $(".sub-entry-tpl").html();
	$(".sub-entry-tpl").empty();
	var entry_tpl = $("#entry-tpl").html();
	//var entry_tpl = $("#entry-tpl");
//--------------------------	

	$('.parse-local-link').live("click",function()
	//$(document).on( "click", ".show-link", function(e) //jquery > 1.7.2
		{
			var url = $(this).attr("href");
			var playlist_id = url.substring(url.indexOf('=')+1, url.length);
			$(this).attr("href","#");
			
			var pls_content_html = "";
			
			var test = $("#" + playlist_id + " .sub-entry-tpl").html().length;			
			if (test == 0)
			{
				var xml_file = "xml/" + playlist_id +".xml";
				$.get(xml_file,function(data)
				{
					$(data).find('entry').each(
						function()
						{
							var entry = $(this);

							var sub_entry_html = sub_entry_tpl;
							var title = entry.find('title').text();
							sub_entry_html = sub_entry_html.replace("{s-title}", title);

							var entry_url = entry.find('link[rel=alternate]').attr("href");
							sub_entry_html = sub_entry_html.replace("{s-playlist-url}", entry_url );
							
							pls_content_html += sub_entry_html;
						});
						
						$("#" + playlist_id + " .sub-entry-tpl").html(pls_content_html);
				});
			}
			
			return false;
		}
	);


	function parse_xml(xml_file)
	{
		$.get(xml_file,function(data)
		{
			$('#xml_data').empty();
			var html = "";
		
			//var upd = $(data).find("updated").get(0);
			var upd = $(data).find("updated:first").text();
			$(".container .updated").text(upd);

			var logo = $(data).find("logo").text();
			$(".container #logo").attr("src",logo);
		
			$(data).find('entry').each(
				function()
				{
					var entry = $(this);
					var title = entry.find('title').text();
				
					var entry_html = entry_tpl;
					entry_html = entry_html.replace("{title}", title);
				
					var playlist_url = entry.find('link[rel=alternate]').attr("href");
					entry_html = entry_html.replace(/{playlist-url}/g, playlist_url );

					var download_url = entry.find('content').attr("src");
					entry_html = entry_html.replace(/{download-url}/g, download_url );

					var xml_file = download_url.substring( download_url.indexOf('/PL2')+1, download_url.length);
					xml_file = xml_file.replace( "?v=2", ".xml");
					entry_html = entry_html.replace(/{xml-file}/g, xml_file );

					entry_html = entry_html.replace("{published}", entry.find('published').text() );
					entry_html = entry_html.replace("{updated}", entry.find('updated').text() );

//var media_group = entry.find('media\\:group');
//alert(media_group.length);
					var def_thumbnail = entry.find('media\\:thumbnail[yt\\:name=default], thumbnail:first').attr("url");
					entry_html = entry_html.replace("{def_thumbnail}", def_thumbnail );

					//var playlist_id = entry.find('yt\\:playlistId').text();
					var playlist_id = entry.find('yt\\:playlistId, playlistId').text();
					entry_html = entry_html.replace("{playlist_id}", playlist_id );
					
//console.log( entry.getElementsByTagNameNS('http://gdata.youtube.com/schemas/2007', 'playlistId'));

					html += entry_html;
	/*
					var entry_obj = entry_tpl;
	//for (item in entry_obj)
	//{
	//console.log ( "entry_obj[" +item+ "]" + entry_obj[item] );
	//}
					$(entry_obj).find(".entry-title").text( title );
					html += entry_obj.html();
	*/				
				
				}
			);//------------------------ end each
			$('#xml_data').append(html);
		});
		return false;
	}//------------------------- end func
	
});// end ready
	
</script>

<style>
.home
{
text-align:center;
}
.top 
{
position: fixed;
bottom: 0;
left: 49%;
background: #C0C0C0;
width: 80px;
height: 40px;
text-align:center;
}
.top .arrow 
{
font-size: 30px;
margin-bottom: -10px;
margin-top: 10px;
}
.top a
{
	text-decoration:none;
}


.container
{
margin-top:30px;
}

.m-wrap
{
margin:10px;
}
.entry-title
{
font-weight:bold;
}
.m-title
{
font-size: 40px;
}
.c1
{
position:relative;
left:-55px;
}
</style>

</head>

<body>

<div class="container container-fluid">

	<div class="row home">
		<a href="../../index.html">up</a>
	</div>

	<div class="row">
		<div class="span1">
			<img id='logo' src="">
		</div>
		<div class="span9">
			<span class="m-title">my playlists</span> <br>(<span class='updated'>Loading...</span>)
		</div>
		
<li><a href="./download_remote_file.php?remote_url=https://gdata.youtube.com/feeds/api/users/UCgp8hFrPYEx2F1SqEB8yUMg/playlists?v=2&xml_file=youtube_playlists.xml" 
target="_blank">download xml from youtube.com</a></li>
<li><a href="./xml/" id="get-list" target="_blank">get all xml files</a></li>

	</div>
	
	<div class="row">
	
		<div id="xml_data">Loading...
<!-- main entry template -->	
			<div id="entry-tpl">
				<div class="m-wrap row" id="{playlist_id}">

					<div class="row">

						<div class="span2">
							<a href="{playlist-url}" class="parse-local-link" target="_blank">
								<img src="{def_thumbnail}">
							</a>
						</div>

						<div class="span6 c1">
							<div class="entry-title">{title}</div>
							<div>published: {published}, updated:{updated}</div>
						
							<a href="{playlist-url}" target="_blank">view from site</a> |
<a href="./download_remote_file.php?remote_url={download-url}&xml_file={xml-file}" 
target="_blank">download xml file</a>
<br>
<a href="{playlist-url}" class="parse-local-link">view local</a> |
<a href="./xml/{xml-file}" target="_blank">source xml file (non cache)</a>
							
						</div>
					</div>
					
<!-- sub entry template -->	
					<div class="sub-entry-tpl">
						<div class="s-wrap row">
							<div class="span2"></div>

							<div class="span6">
								<a href="{s-playlist-url}" target="_blank">{s-title}</a> 
							</div>
						</div>
					</div>
<!-- /sub entry template -->	
										
				</div>
			</div>
<!-- /main entry template -->	
	
		</div>
		
	</div>
</div><!-- end container -->

<div class="top">
	<a id="top-link" title="наверх" href="javascript:scroll(0,0)">
		<div class="arrow">^</div>наверх
	</a>
</div>

</body>
</html>
