var sharedFunc=sharedFunc||function(){function a(e){return document.querySelector?document.querySelector("#"+e):document.getElementById?document.getElementById(e):!!document.all&&document.all[e]}function n(e,t){if(!(t=t||t))t="log";var r=a(t);r?0==e.length?r.innerHTML="":r.innerHTML=e+r.innerHTML:console.log(e),"block"!==r.style.display&&(r.style.display="block")}function l(e,t){var r=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return t&&("RU"!==t&&"ru"!==t||(r=["Янв","Фев","Март","Апр","Май","Июн","Июл","Авг","Сент","Окт","Ноя","Дек"])),r.indexOf(e)}return{getById:a,log:n,push:function(e,t){e.push?e.push(t):e[e.length]=t},set_timer:function(){return(new Date).getTime()},get_timer:function(e){var t=new Date;return parseFloat((t.getTime()-e)/1e3)},get_attr_to_obj:function(e){if(0===e.length)return!1;for(var t={},r=0;r<e.length;r++)t[e[r].name]=e[r].value;return t},sortRecords:function(e){var t,o={records:[],sortOrder:"asc",sortByKey:null};for(var r in e)o[r]=e[r];return 0===o.records.length?(n("<div class='alert alert-danger'>"+(t="error, not found sorting records, function sortRecords()")+"</div>"),console.log(t),!1):o.sortByKey?void o.records.sort(function(e,t){var r=e[o.sortByKey],a=t[o.sortByKey];switch(o.sortOrder){case"asc":return a<r?1:r<a?-1:0;case"desc":return a<r?-1:r<a?1:0}}):(n("<div class='alert alert-danger'>"+(t="error, not found 'sortByKey', function sortRecords()")+"</div>"),console.log(t),!1)},parseGetParams:function(e){if(e){p=e.split("?");t=(e=p[1]).split("&")}else var t=window.location.search.substring(1).split("&");for(var r={},a=0;a<t.length;a++){var o=t[a].split("=");void 0===o[1]?r[o[0]]="":r[o[0]]=o[1]}return r},parseHashParams:function(e){if(e){p=e.split("#");t=(e=p[1]).split("&")}else var t=window.location.hash.substring(1).split("&");for(var r={},a=0;a<t.length;a++){var o=t[a].split("=");void 0===o[1]?r[o[0]]="":r[o[0]]=o[1]}return r},runAjax:function(e){var t,a={requestMethod:"GET",responseType:"",enctype:"application/x-www-form-urlencoded",url:!1,params:null,formData:null,async:!0,callback:null,onProgress:null,onError:null,onLoadEnd:null,noCache:!1};for(var r in e)a[r]=e[r];var o=a.requestMethod,n=a.url,s=a.async,l=a.callback,i=0;if(a.params){var c="";for(var p in a.params){0<i&&(c+="&"),c+=p+"="+(v=encodeURIComponent(a.params[p])),i++}n+="?"+c}if(a.noCache&&(-1!==n.indexOf("?")?n+="&noCache=":n+="?noCache=",n+=(new Date).getTime()+Math.random()),!n||0===n.length)return t="error,  empty 'url' value.",console.log(t),"function"==typeof a.onError&&a.onError({message:t}),!1;var u=function(){var e=!1;window.XMLHttpRequest&&(e=new XMLHttpRequest);e=e||new ActiveXObject("Microsoft.XMLHTTP");e=e||new ActiveXObject("Msxml2.XMLHTTP");return e}();if(!u)return console.log("error, ",u),t="_createRequestObject() error",console.log(t,u),"function"==typeof a.onError&&a.onError({message:"error creating XHR...."}),!1;var d=new Date;try{u.open(o,n,s)}catch(e){return"function"==typeof a.onError&&a.onError(e),!1}function g(){var e={all:u.getAllResponseHeaders(),"content-type":u.getResponseHeader("content-type")};"function"==typeof a.onLoadEnd&&a.onLoadEnd(e)}if("responseType"in u&&a.async&&(u.responseType=a.responseType),u.onreadystatechange=function(){if(4==u.readyState)if(200===u.status){var e=((new Date).getTime()-d.getTime())/1e3;if("function"==typeof l){if("response"in u)var t=u.response;else t=u.responseText;var r=u.getResponseHeader("Content-Type");-1===r.indexOf("application/xml")&&-1===r.indexOf("text/xml")||(t=u.responseXML),-1!==r.indexOf("text/plain")&&(t=u.responseText),l(t,e,u)}"onloadend"in u||g()}else"function"==typeof a.onError&&a.onError({message:"ajax load request error.",url:u.responseURL,"xhr.status":u.status,"xhr.statusText":u.statusText})},"onloadstart"in u&&(u.onloadstart=function(e){}),"onload"in u&&(u.onload=function(e){}),"onloadend"in u&&(u.onloadend=function(e){g()}),"onprogress"in u&&(u.onprogress=function(e){"function"==typeof a.onProgress&&a.onProgress(e)}),"onabort"in u&&(u.onabort=function(e){}),"onerror"in u&&(u.onerror=function(e){console.log("event type:"+e.type),console.log("time: "+e.timeStamp),console.log("total: "+e.total),console.log("loaded: "+e.loaded)}),u.upload,"POST"!==o)try{u.send()}catch(e){console.log(e),"function"==typeof a.onError&&a.onError({message:"error send XHR...."})}if("POST"===o&&("multipart/form-data"===a.enctype&&u.send(a.formData),"application/x-www-form-urlencoded"===a.enctype)){"setRequestHeader"in u&&u.setRequestHeader("Content-Type",a.enctype);var b="",f=0;for(var r in a.formData){var v=a.formData[r];0<f&&(b+="&"),b+=r+"="+encodeURIComponent(v),f++}u.send(b)}},runAjaxCorrect:function(e){var r={requestMethod:"GET",url:!1,async:!0,onProgress:null,onSuccess:null,onError:null};for(var t in e)r[t]=e[t];var a=r.requestMethod,o=r.url,n=r.async;try{var s=new XMLHttpRequest}catch(e){console.log(e)}var l=new Date;s.open(a,o,n),s.onreadystatechange=function(){if(4===s.readyState){if(console.log("end request, state ",s.readyState,", status: ",s.status),200===s.status&&"function"==typeof r.onSuccess){var e=((new Date).getTime()-l.getTime())/1e3,t=s.responseText;r.onSuccess(t,e,s)}200!==s.status&&(console.log("Ajax load error, url: "+s.responseURL),console.log("statusText:"+s.statusText),"function"==typeof r.onError&&r.onError(s))}},"onerror"in s&&(s.onerror=function(e){console.log("xhr.onerror,",e)}),"onloadend"in s&&(s.onloadend=function(e){}),s.send()},timeStampToDateStr:function(e){var t={timestamp:null,format:""};for(var r in e)t[r]=e[r];if(t.timestamp&&0!==t.timestamp.length)a=new Date(t.timestamp);else var a=new Date;var o=a.getFullYear(),n=a.getMonth()+1;n<10&&(n="0"+n);var s=a.getDate();s<10&&(s="0"+s);var l=a.getHours();l<10&&(l="0"+l);var i=a.getMinutes();i<10&&(i="0"+i);var c=a.getSeconds();c<10&&(c="0"+c);var p=s+"-"+n+"-"+o+" "+l+":"+i+":"+c;switch(t.format){case"yyyy-mm-dd":p=o+"-"+n+"-"+s;break;case"yyyy-mm-dd hh:min":p=o+"-"+n+"-"+s+" "+l+":"+i;break;case"yyyy-mm-dd hh:min:sec":p=o+"-"+n+"-"+s+" "+l+":"+i+":"+c}return p},getTimeStampFromDateStr:function(e){var t,r=parseInt(e.day);isNaN(r)&&(r=0),t=l(e.month);var a=parseInt(e.year);isNaN(a)&&(a=0);var o=parseInt(e.hour);isNaN(o)&&(o=0);var n=parseInt(e.min);isNaN(n)&&(n=0);var s=parseInt(e.sec);return isNaN(s)&&(s=0),new Date(a,t,r,o,n,s).getTime()},getMonthByNameNum:function(e,t){var r=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"];return"RU"!==t&&"ru"!==t||(r=["янв","фев","март","апр","май","июн","июл","авг","сент","окт","ноя","дек"]),r[e]},getNumMonthByName:l,hashCode:function(e){var t=0;if(0==e.length)return t;for(i=0;i<e.length;i++)char=e.charCodeAt(i),t=(t<<5)-t+char,t&=t;return t},parseXmlToObj:function(n,e){for(var t=e.documentElement.nodeName,r=e.getElementsByTagName(t),a=[],o=0;o<r.item(0).childNodes.length;o++){var s=r.item(0).childNodes.item(o);if(1===s.nodeType){var l=i(s);a.push(l)}}return a;function i(e){for(var t=n.get_attr_to_obj(e.attributes),r=0;r<e.childNodes.length;r++){var a=e.childNodes.item(r);if(1===a.nodeType){var o=a.nodeName;t[o]="textContent"in a?a.textContent:a.text}}return t}},convertXmlToObj:function(e){for(var t=e.documentElement.nodeName,r=e.getElementsByTagName(t),a={},o=0;o<r.length;o++){var n=r.item(o),s=n.nodeName;a[s]={},c(n,a[s])}return a;function c(e,t){var r=e.childNodes;0<r.length&&(1===r.length&&3===r.item(0).nodeType||(t.childNodes={}));for(var a=0;a<r.length;a++){var o=r.item(a);if(1!==o.nodeType){if(3===o.nodeType){var n="";0<(n=(n="textContent"in o?o.textContent:o.text).trim()).length&&"\n"!==n&&"\n\n"!==n&&"\n\n\n"!==n&&(t.text=n)}}else{var s=o.nodeName;t.childNodes[s]||(t.childNodes[s]=[]);var l={},i=p(o.attributes);i&&(l.attributes=i),t.childNodes[s].push(l),c(o,l)}}}function p(e){if(0===e.length)return!1;for(var t={},r=0;r<e.length;r++)t[e[r].name]=e[r].value;return t}},logAlert:function(e,t){switch(t){case"info":n(e="<p class='uk-alert uk-alert-primary'>"+e+"</p>");break;case"warning":n(e="<p class='uk-alert uk-alert-warning'>"+e+"</p>");break;case"danger":case"error":n(e="<p class='uk-alert uk-alert-danger'>"+e+"</p>");break;case"success":n(e="<p class='uk-alert uk-alert-success'>"+e+"</p>");break;default:n(e)}},wrapLogMsg:function(e,t){switch(t){case"info":return e="<p class='alert alert-info'>"+e+"</p>";case"warning":return e="<p class='alert alert-warning'>"+e+"</p>";case"danger":case"error":return e="<p class='alert alert-danger'>"+e+"</p>";case"success":return e="<p class='alert alert-success'>"+e+"</p>";default:return e}},addEvent:function(e,t,r){return e.addEventListener?e.addEventListener(t,r,!1):e.attachEvent?e.attachEvent("on"+t,r):void 0},testSupport:function(){return{jsonSupport:!!JSON,promiseSupport:!!window.Promise,cacheSupport:!!window.caches,serviceWorkerSupport:!!navigator.serviceWorker,indexedDBsupport:!!window.indexedDB,webSQLsupport:!!window.openDatabase,localStorageSupport:!!window.localStorage,dataStoreType:function(){var e=!1;window.localStorage&&(e="localStorage");window.openDatabase&&(e="webSQL");window.indexedDB&&(e="indexedDB");return e}(),geolocationSupport:void 0!==navigator.geolocation,supportTouch:function(){var e=false;if("ontouchstart"in window){e=true}else if(window.navigator.msMaxTouchPoints){e=true}return e}(),fileAPI:function(){if(window.File&&window.FileList&&window.FileReader){return true}return false}(),formData:"function"==typeof window.FormData}}}};window.console||(window.console={log:function(e){var t=!1;document.querySelector&&(t=document.querySelector("#log")),document.getElementById&&(t=document.getElementById("log")),document.all&&(t=document.all.log),t?t.innerHTML+=e+"<br>":alert(e)}}),"function"==typeof window.jQuery&&$(document).ready(function(){$("#scroll-to-top").click(function(e){return e.preventDefault,$("html,body").animate({scrollTop:0},500),!1})});var func=sharedFunc(),_vars={logMsg:"",start_scroll_pos:0,end_scroll_pos:0};function initApplication(){_vars.logMsg=navigator.userAgent,func.logAlert(_vars.logMsg,"info")}function _initPage(){_vars.start_scroll_pos=$("#main").offset().top+100,_vars.end_scroll_pos=_vars.start_scroll_pos-20,$("#btn-scroll-to-top").hide(),$(".scroll-to").addClass("nolink").on("click",function(){if($(this).attr("href"))var e=$(this).attr("href");else e="#"+$(this).attr("data-target");var t=$(e).offset().top;return t-=100,$("html,body").animate({scrollTop:t},500),!1})}document.addEventListener&&document.addEventListener("DOMContentLoaded",function(){initApplication()},!1),window.onload=function(){"object"==typeof webApp&&webApp.init(function(){console.log("end webApp initialize....")})},"function"==typeof window.jQuery&&($(document).ready(function(){_initPage()}),$(window).scroll(function(){$(this).scrollTop()>_vars.start_scroll_pos&&$("#btn-scroll-to-top").show(),$(this).scrollTop()<_vars.end_scroll_pos&&$("#btn-scroll-to-top").hide()}));var webApp={app:_app(),db:_db(),draw:_draw(),player:_player(),fileManager:_fileManager(),vars:{app_title:"music collection",logMsg:"",GET:{},audioTypes:{},use_file_manager:!0,support:func.testSupport(),blocks:[{locationID:"block-player",title:"block player",templateID:"blockPlayer",content:function(){this.content="",webApp.draw.buildBlock(this),webApp.player.init()}},{locationID:"block-tracklist",title:"block tracklist",templateID:"blockTrackList",content:function(){var e=webApp.player.formHtmlTrackList();e&&0<e.length&&(this.content=e,webApp.draw.buildBlock(this))}},{locationID:"block-tag-groups",title:"block tag groups",templateID:"blockTagGroups",content:function(){var e=webApp.app.formHtmlTagGroups();e&&0<e.length&&(this.content=e,webApp.draw.buildBlock(this))}},{locationID:"block-taglist",title:"block taglist",templateID:"blockTagList",content:function(){var e=webApp.app.formHtmlTagList({vid:webApp.vars.GET.vid,group_name:webApp.vars.GET.group_name});e&&0<e.length&&(this.content=e,webApp.draw.buildBlock(this))}},{locationID:"block-file-manager",title:"block file manager",templateID:"blockFileManager",content:function(){webApp.fileManager.formHtmlFileManager({postFunc:function(e){e&&0<e.length&&(webApp.vars.blocksByName.blockFM.content=e,webApp.draw.buildBlock(webApp.vars.blocksByName.blockFM))}})}},{locationID:"block-pager",title:"block pager",templateID:"blockPager",visibility:!0},{locationID:"block-list",title:"block nodelist",templateID:"blockNodes",visibility:!0,content:function(){var e=webApp.app.formHtmlNodeList();e&&0<e.length&&(this.content=e,webApp.draw.buildBlock(this)),webApp.app.imagesLoadEventHandler(),$("a[href='?q=load-tracklist&url=']").hide(),webApp.draw.updatePager()}},{locationID:"block-links",title:"footer links",templateID:"blockFooterLinks",visibility:!0,content:function(){var e=webApp.draw.wrapData({data:webApp.db.vars.footerLinks,templateID:"blockLinksList",templateListItemID:"blockLinksListItem"});e&&0<e.length&&(this.content=e,webApp.draw.buildBlock(this))}}],blocksByName:{},imageNotLoad:"img/image_not_load.png",menuWidth:270},init:function(e){console.log("init webapp!");var t=func.getById("app-title");function r(){webApp.vars.blocksByName.blockPlayer=webApp.vars.blocks[0],webApp.vars.blocksByName.blockTrackList=webApp.vars.blocks[1],webApp.vars.blocksByName.blockTagGroups=webApp.vars.blocks[2],webApp.vars.blocksByName.blockTagList=webApp.vars.blocks[3],webApp.vars.blocksByName.blockFM=webApp.vars.blocks[4],webApp.vars.blocksByName.blockPager=webApp.vars.blocks[5],webApp.vars.blocksByName.blockNodes=webApp.vars.blocks[6],webApp.vars.blocksByName.blockFooterLinks=webApp.vars.blocks[7],webApp.vars.logPanel=func.getById("log"),webApp.vars.waitWindow=func.getById("win1"),webApp.vars.loadProgress=func.getById("load-progress"),webApp.vars.loadProgressBar=func.getById("load-progress-bar"),webApp.vars.numTotalLoad=func.getById("num-total-load"),webApp.vars.percentComplete=func.getById("percent-complete"),webApp.vars.totalBytes=func.getById("total"),webApp.vars.totalMBytes=func.getById("total-mb"),webApp.vars.loaded=func.getById("loaded"),webApp.vars.loadInfo=func.getById("load-info"),webApp.vars.$offcanvas=$("#off-canvas2"),webApp.vars.$offcanvasBar=$("#off-canvas2 .my-offcanvas-bar"),webApp.vars.$offcanvasMenu=$("#off-canvas2 .uk-nav-offcanvas > li > a"),webApp.vars.$blockList=document.querySelector("#block-list"),"range"!==$("#page-range").attr("type")&&$("#page-range").hide(),_runApp()}t&&(t.innerHTML=this.vars.app_title),webApp.db.init(),webApp.draw.init(),webApp.player.testMediaSupport(),webApp.vars.use_file_manager?webApp.fileManager.init({postFunc:r}):r()}};function _runApp(){webApp.vars.waitWindow&&(webApp.vars.waitWindow.style.display="block"),webApp.db.getData(function(e){webApp.vars.waitWindow&&(webApp.vars.waitWindow.style.display="none"),webApp.db.vars.nodes&&0<webApp.db.vars.nodes.length&&_postLoad()})}function _postLoad(){var e=window.location.search;0<e.length&&webApp.app.urlManager(e),console.log("-- start build page --"),webApp.draw.buildPage(),console.log("-- end build page --"),webApp.app.defineEvents()}function _app(e){var l={duration:600};function i(e){switch(webApp.vars.GET=func.parseGetParams(e),webApp.vars.GET.num_page&&0<webApp.vars.GET.num_page.length&&(webApp.db.vars.numberPage=webApp.vars.GET.num_page),webApp.vars.GET.dir&&0<webApp.vars.GET.dir.length&&(webApp.fileManager.vars.aliasLocation=webApp.vars.GET.dir,webApp.fileManager.vars.fsPath=webApp.vars.GET.dir),webApp.vars.GET.q){case"edit-node":u("#modal-edit-node"),document.forms.form_node.elements.id.value=webApp.vars.GET.nid;break;case"get-tag-list":webApp.draw.buildBlock(webApp.vars.blocksByName.blockTagList);break;case"get-nodes-by-tag":webApp.db.getNodesByTag({tagName:webApp.vars.GET.tag_name,callback:function(e){if(e&&0!==e.length){webApp.vars.logMsg="found <b>"+e.length+"</b> records for tag &quot;<b>"+webApp.vars.GET.tag_name+"</b>&quot;",func.logAlert(webApp.vars.logMsg,"success"),webApp.db.vars.queryRes=e,webApp.db.vars.numberPage=1,webApp.draw.buildBlock(webApp.vars.blocksByName.blockNodes);var t="#"+webApp.vars.blocksByName.blockTagList.locationID;$(t).slideToggle(l.duration,function(e){})}else webApp.vars.logMsg="not found records for tag <b>"+webApp.vars.GET.tag_name+"</b>...",func.logAlert(webApp.vars.logMsg,"warning"),console.log("-- "+webApp.vars.logMsg)}});break;case"reset_tags_select":webApp.db.vars.queryRes=[],webApp.db.vars.numberPage=1,webApp.draw.buildBlock(webApp.vars.blocksByName.blockNodes);break;case"search":webApp.db.search({targetField:webApp.vars.GET.targetField,keyword:webApp.vars.GET.keyword,callback:function(e){if(!e||0===e.length)return webApp.vars.logMsg="no records found by keyword <b>&quot;"+webApp.vars.GET.keyword+"&quot;</b>...",func.logAlert(webApp.vars.logMsg,"warning"),console.log("-- "+webApp.vars.logMsg),!1;webApp.vars.logMsg="found <b>"+e.length+"</b> records by keyword &quot;<b>"+webApp.vars.GET.keyword+"</b>&quot;",func.logAlert(webApp.vars.logMsg,"success"),webApp.db.vars.queryRes=e,webApp.db.vars.numberPage=1,webApp.draw.buildBlock(webApp.vars.blocksByName.blockNodes)}});break;default:console.log("function _urlManager(),  GET query string: ",webApp.vars.GET)}}function s(e,t){for(var r=[],a=0;a<t.length;a++)t[a].group_name===e&&r.push(t[a]);return r}function c(e,t){for(var r=[],a=0;a<t.length;a++)if(t[a].node_tags&&0<t[a].node_tags.length)for(var o=t[a].node_tags,n=0;n<o.length;n++)o[n].text===e.text&&r.push(t[a]);return r}function p(e){var t=parseInt(e);if(isNaN(t))return webApp.vars.logMsg="-- error, incorrect input "+t,func.logAlert(webApp.vars.logMsg,"danger"),console.log(webApp.vars.logMsg),t=1,void $("#page-number").val(t);0===t&&(webApp.vars.logMsg="-- error, wrong num page",func.logAlert(webApp.vars.logMsg,"danger"),console.log(webApp.vars.logMsg,t,webApp.db.vars.numPages),t=1,$("#page-number").val(t)),t>webApp.db.vars.numPages&&(webApp.vars.logMsg="-- error, wrong num page",func.logAlert(webApp.vars.logMsg,"danger"),console.log(webApp.vars.logMsg,t,webApp.db.vars.numPages),t=webApp.db.vars.numPages,$("#page-number").val(t)),$("#page-range").val(t),webApp.db.vars.numberPage=t,webApp.draw.buildBlock(webApp.vars.blocksByName.blockNodes)}function r(){var e=parseInt(webApp.vars.$offcanvasBar.css("width"));0==e&&(webApp.vars.$offcanvas.css("display","block"),webApp.vars.$offcanvasBar.css("width",webApp.vars.menuWidth)),parseInt(e)==webApp.vars.menuWidth&&(webApp.vars.$offcanvas.css("display","none"),webApp.vars.$offcanvasBar.css("width",0))}function u(t){$(t).hasClass("uk-hidden")&&($(t).removeClass("uk-hidden"),$(t).hide()),$(t).hasClass("uk-open")?$(t).removeClass("uk-open"):$(t).addClass("uk-open"),$(t).slideToggle(l.duration,function(e){"#log"===t&&(webApp.vars.logPanel.innerHTML="")})}return{defineEvents:function(){$(document).on("keydown",function(e){var t=(e=e||window.event).target||e.srcElement;if(27==e.keyCode){var r="#modal-edit-node",a=$(r);a.is(":visible")&&u(r),r="#modal-insert-track",(a=$(r)).is(":visible")&&u(r)}if("page-number"===t.getAttribute("id")){if(13==e.keyCode&&p(t.value),46==e.keyCode||8==e.keyCode||9==e.keyCode||27==e.keyCode||65==e.keyCode&&!0===e.ctrlKey||35<=e.keyCode&&e.keyCode<=39)return;(e.keyCode<48||57<e.keyCode)&&(e.keyCode<96||105<e.keyCode)&&e.preventDefault()}}),$(document).on("change",function(e){var t=(e=e||window.event).target||e.srcElement;"page-range"===t.getAttribute("id")&&($("#page-number").val(t.value),p(t.value)),"select-sort"===t.getAttribute("id")&&(webApp.db.vars.sortByKey=t.value,p(1))}),document.forms.formSearch.onsubmit=function(e){(e=e||window.event).target||e.srcElement;e.preventDefault?e.preventDefault():e.returnValue=!1;var t=document.forms.formSearch,r=!0,a=t.elements.keyword.value;0===a.length&&(l.logMsg="error, empty keyword...",func.logAlert(l.logMsg,"error"),r=!1);var o=!1;if(0<t.elements.targetField.length)for(var n=0;n<t.elements.targetField.length;n++){var s=$(t.elements.targetField[n]);if(s.prop("checked")){o=s.attr("value");break}}else o=t.elements.targetField.value;r&&i("?q=search&targetField="+o+"&keyword="+a)},document.forms.form_insert_track.onsubmit=function(e){(e=e||window.event).target||e.srcElement;e.preventDefault?e.preventDefault():e.returnValue=!1;var t=document.forms.form_insert_track,r=webApp.player.vars.GET.q;console.log(r,webApp.player.vars.GET),"edit-track"===r?$("#insert-track-form").attr("action","?q=update-track"):$("#insert-track-form").attr("action","?q=insert-track"),console.log(t.action);for(var a=t.action,o=!0,n=0;n<t.elements.length;n++){var s=t.elements[n];if(-1!==s.className.indexOf("require-form-element")&&0===s.value.length){o=!1;l.logMsg="error, empty required input field <b>'"+s.name+"'</b>",func.logAlert(l.logMsg,"error");break}0<s.value.length&&(a+="&"+s.name+"="+s.value)}o&&webApp.player.urlManager(a)},$("#page-range").on("input",function(e){var t=(e=e||window.event).target||e.srcElement;$("#page-number").val(t.value)}),$("#page-number").on("blur",function(e){p(((e=e||window.event).target||e.srcElement).value)}),$(document).on("click",function(e){var t=(e=e||window.event).target||e.srcElement;-1===t.className.indexOf("no-block-link")&&(e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,e.preventDefault?e.preventDefault():e.returnValue=!1,function(e){if(-1!==e.className.indexOf("btn-dropdown")){var t=e.parentNode;$(t).find(".block-content").slideToggle(l.duration);var r=$(e);r.hasClass("icon-chevron-down")?(r.removeClass("icon-chevron-down"),r.addClass("icon-chevron-up")):(r.removeClass("icon-chevron-up"),r.addClass("icon-chevron-down"))}if("btn-page-number-more"===e.getAttribute("id")){(a=parseInt($("#page-number").val()))<webApp.db.vars.numPages&&($("#page-number").val(a+1),$("#page-range").val(a+1),p($("#page-range").val()))}if("btn-page-number-less"===e.getAttribute("id")){var a;1<(a=parseInt($("#page-number").val()))&&($("#page-number").val(a-1),$("#page-range").val(a-1),p($("#page-range").val()))}if("A"===e.tagName){if(e.getAttribute("data-toggle")){var o=$(e).data("toggle");-1===e.href.indexOf("?q=close")&&-1===e.href.indexOf("?q=toggle")||(u(o),webApp.player.vars.GET={})}if(-1!==e.href.indexOf("q=edit-node")&&webApp.app.urlManager(e.href),-1!==e.href.indexOf("get-tag-list")&&webApp.app.urlManager(e.href),-1!==e.href.indexOf("get-nodes-by-tag")&&webApp.app.urlManager(e.href+"&tag_name="+$(e).text()),-1===e.href.indexOf("q=get-tracklist-url")&&-1===e.href.indexOf("q=load-tracklist")||webApp.player.urlManager(e.href),-1===e.href.indexOf("q=load-track&")&&-1===e.href.indexOf("prev-track")&&-1===e.href.indexOf("next-track")&&-1===e.href.indexOf("clear-tracklist")&&-1===e.href.indexOf("remove-track")&&-1===e.href.indexOf("edit-track")||(0<webApp.player.vars.trackList.length?webApp.player.urlManager(e.href):(webApp.vars.logMsg="warning, empty media track list ...",func.logAlert(webApp.vars.logMsg,"warning"))),-1!==e.href.indexOf("q=get-folder")||-1!==e.href.indexOf("q=define-location")||-1!==e.href.indexOf("q=level-up")||-1!==e.href.indexOf("q=check-all")||-1!==e.href.indexOf("q=clear-all")||-1!==e.href.indexOf("q=rename-file")||-1!==e.href.indexOf("q=delete-file")||-1!==e.href.indexOf("q=add-track")){var n=e.href;-1!==e.href.indexOf("q=get-folder")&&(n=e.getAttribute("href")),webApp.fileManager.urlManager(n)}}}(t))}),$("#btn-toggle-menu").on("click",function(e){r()}),$("#btn-close-menu").on("click",function(e){r()}),webApp.vars.$offcanvasMenu.on("click",function(e){$(".collapse").hide();var t=$(e.target).data("toggle");$(t).show(l.duration,function(e){r()})})},urlManager:function(e){return i(e)},formHtmlNodeList:function(){webApp.db.vars.records=webApp.db.vars.nodes,0<webApp.db.vars.queryRes.length&&(webApp.db.vars.records=webApp.db.vars.queryRes),webApp.db.vars.sortByKey&&0<webApp.db.vars.sortByKey.length&&webApp.db.sortNodes({records:webApp.db.vars.records,sortOrder:webApp.db.vars.sortOrder,sortByKey:webApp.db.vars.sortByKey}),webApp.db.vars.outputBuffer=[];var e=parseInt(webApp.db.vars.numberPage)-1,t=webApp.db.vars.numRecordsPerPage,r=e*t,a=r+t;if(r>webApp.db.vars.records.length)return webApp.vars.logMsg="-- warning, incorrect page number, not more than "+webApp.db.vars.numPages,console.log(webApp.vars.logMsg),!1;a>webApp.db.vars.records.length&&(a-=o=a-webApp.db.vars.records.length);for(var o=r;o<a;o++)webApp.db.vars.outputBuffer.push(webApp.db.vars.records[o]);for(o=0;o<webApp.db.vars.outputBuffer.length;o++)if(webApp.db.vars.outputBuffer[o].main_picture="",webApp.db.vars.outputBuffer[o].images&&(webApp.db.vars.outputBuffer[o].images[0].template="hide",webApp.db.vars.outputBuffer[o].main_picture=webApp.db.vars.outputBuffer[o].images[0].src),webApp.db.vars.outputBuffer[o].related_links)for(var n=webApp.db.vars.outputBuffer[o].related_links,s=0;s<n.length;s++){var l=n[s];"playlist-file"===l["data-type"]&&(webApp.db.vars.outputBuffer[o].playlist_filepath=l.href,l.template="hide element")}return webApp.draw.wrapData({data:webApp.db.vars.outputBuffer,templateID:"blockList",templateListItemID:"blockListItem"})},formHtmlTagGroups:function(){for(var e=[],t=0;t<webApp.db.vars.tagGroups.length;t++){_group=webApp.db.vars.tagGroups[t];var r=s(_group.name,webApp.db.vars.tagList);0<r.length&&(_group.num=r.length,e.push(_group))}return webApp.draw.wrapData({data:e,templateID:"tagGroupsList",templateListItemID:"tagGroupsListItem"})},formHtmlTagList:function(e){var t={vid:null,group_name:null};for(var r in e)t[r]=e[r];for(var a=s(t.group_name,webApp.db.vars.tagList),o=0;o<a.length;o++){var n=c(a[o],webApp.db.vars.nodes);a[o].num="0",0<n.length&&(a[o].num=n.length)}return webApp.draw.wrapData({data:a,templateID:"tagList",templateListItemID:"tagListItem"})},imagesLoadEventHandler:function(){for(var e=webApp.vars.$blockList.getElementsByTagName("img"),t=0;t<e.length;t++)e[t].onerror=function(e){webApp.vars.logMsg="error, image not load, <small><b>"+e.target.src+"</b></small>",e.target.parentNode.className="block-images-not-load",e.target.outerHTML="<div class='img-not-load'>"+webApp.vars.logMsg+"</div>"},e[t].onload=function(e){e.target.parentNode.style.background="transparent"}},toggleBlock:u}}function _db(t){var d={dataUrl:"db/export_music.xml",dbType:"xml",dbName:"music",tagNameNodes:"node",tagName:"tag",tagListName:"tag_list",tagGroupsName:"tag_groups",footerLinks:[{url:"https://music.yandex.ru/users/roman-laptev/playlists",title:"music.yandex.ru"},{url:"https://www.youtube.com/channel/UCgp8hFrPYEx2F1SqEB8yUMg/playlists",title:"youtube playlists"},{url:"https://vk.com/audios36466377",title:"music on VK.com"},{url:"https://ok.ru/music/profile/508693848602",title:"music on OK.ru"},{url:"https://cloud.mail.ru/public/bbb2f6a3eb1d/music",title:"music on cloud.mail.ru"}],numRecordsPerPage:5,numberPage:1,numPages:null,sortOrder:"asc",sortByKey:"",dateFormat:"dd-mm-yyyy hh:mm:ss",outputBuffer:[],queryRes:[]};function r(a){switch(d.dataStoreType){case"indexedDB":case"webSQL":case"localStorage":break;default:if(!d.dataUrl||0===d.dataUrl.length)return webApp.vars.logMsg="error, not found or incorrect 'dataUrl'...",func.logAlert(webApp.vars.logMsg,"error"),"function"==typeof a&&a(),!1;webApp.vars.loadProgress.style.display="block",func.runAjax({requestMethod:"GET",url:d.dataUrl,onProgress:function(e){var t=0;e.lengthComputable&&(t=Math.ceil(e.loaded/e.total*100)),console.log("Loaded "+e.loaded+" bytes of total "+e.total,e.lengthComputable,t+"%"),webApp.vars.totalBytes.innerHTML=e.total,webApp.vars.totalMBytes.innerHTML=(e.total/1024/1024).toFixed(2),webApp.vars.loaded.innerHTML=e.loaded,webApp.vars.loadProgressBar&&(webApp.vars.loadProgressBar.style.width=t+"%",webApp.vars.loadProgressBar.innerHTML=t+"%")},onLoadEnd:function(e){var t=webApp.vars.loadInfo.textContent.trim();t+=", "+d.dataUrl,func.logAlert(t,"info")},onError:function(t){for(var r in e)webApp.vars.logMsg="<b>"+r+"</b> : "+e[r],func.logAlert(webApp.vars.logMsg,"error");webApp.vars.logMsg="error, ajax load failed..."+d.dataUrl,func.logAlert(webApp.vars.logMsg,"error"),console.log(webApp.vars.logMsg),"function"==typeof a&&a()},callback:function(e){if(!e)return webApp.vars.logMsg="error, no data in "+d.dataUrl,func.logAlert(webApp.vars.logMsg,"error"),console.log(webApp.vars.logMsg),"function"==typeof a&&a(!1),!1;!function(e){if(0===d.dbType.length)return webApp.vars.logMsg="error, no found or incorrect "+d.dbType,console.log(webApp.vars.logMsg);switch(d.dbType){case"xml":!function(e){var t=new Date;try{xmlObj=func.convertXmlToObj(e),delete e,d.nodes=function(e){for(var t=e.xroot.childNodes.database,r=d.dbName,a=d.tagNameNodes,n=[],o=0;o<t.length;o++)if(t[o].attributes.name===r)var s=e.xroot.childNodes.database[o].childNodes[a];if(0<s.length)for(o=0;o<s.length;o++){var l={type:s[o].attributes.type};for(var i in s[o].childNodes){var c=s[o].childNodes[i][0].text;s[o].childNodes[i][0].childNodes&&(c=p(s[o].childNodes[i][0].childNodes)),l[i]=c}l.nid=o,n.push(l)}return function(){if("dd-mm-yyyy hh:mm:ss"!==webApp.db.vars.dateFormat)return;for(var e=0;e<n.length;e++)if(n[e].updated&&0<n[e].updated.length){var t=n[e].updated.split(" "),r=t[0].split("-"),a=t[1].split(":"),o={day:r[0],month:r[1],year:r[2],hour:a[0],min:a[1],sec:a[2]};n[e].timestamp=func.getTimeStampFromDateStr(o)}}(),n;function p(e){var t=[];for(var r in e){var a=e[r];for(var o in a)if(a[o].childNodes){var n=a[o].childNodes;for(var s in n){var l={};n[s][0].attributes&&(l=n[s][0].attributes),n[s][0].text&&(l.text=n[s][0].text),t.push(l)}}else{l={};a[o].attributes&&(l=a[o].attributes),a[o].text&&(l.text=a[o].text),t.push(l)}}return t}}(xmlObj);for(var r=0;r<d.numRecordsPerPage;r++)d.outputBuffer.push(d.nodes[r]);d.tagList=function(e){for(var t=e.xroot.childNodes.database,r=d.dbName,a=d.tagListName,o=d.tagName,n=[],s=0;s<t.length;s++)if(t[s].attributes.name===r)for(var l=e.xroot.childNodes.database[s].childNodes[a][s].childNodes[o],i=0;i<l.length;i++){var c={};l[i].attributes&&(c=l[i].attributes),l[i].text&&(c.text=l[i].text),n.push(c)}return 0<n.length&&(func.sortRecords({records:n,sortOrder:"asc",sortByKey:"text"}),n)}(xmlObj),d.tagGroups=function(e){for(var t=e.xroot.childNodes.database,r=d.dbName,a=d.tagGroupsName,o=[],n=0;n<t.length;n++)if(t[n].attributes.name===r)for(var s=e.xroot.childNodes.database[n].childNodes[a][n].childNodes.item,l=0;l<s.length;l++){var i={};s[l].attributes&&(i=s[l].attributes),s[l].text&&(i.text=s[l].text),o.push(i)}return 0<o.length&&(func.sortRecords({records:o,sortOrder:"asc",sortByKey:"text"}),o)}(xmlObj),delete xmlObj;var a=((new Date).getTime()-t.getTime())/1e3;webApp.vars.logMsg="- convertXmlToObj(), runtime: <b>"+a+"</b> sec",func.logAlert(webApp.vars.logMsg,"info")}catch(e){for(var o in webApp.vars.logMsg="convertXmlToObj(), error parse XML...",func.logAlert(webApp.vars.logMsg,"error"),console.log(e),e)webApp.vars.logMsg="<b>"+o+"</b> : "+e[o],func.logAlert(webApp.vars.logMsg,"error")}}(e)}}(e),"function"==typeof a&&a()}})}}return{vars:d,init:function(e){},getData:function(e){return r(e)},getNodesByTag:function(e){var t={tagName:null,callback:null};for(var r in e)t[r]=e[r];if(!t.tagName||0===t.tagName.length)return webApp.vars.logMsg="-- error, not found tag name value, webApp.db.getNodesByTag()...",console.log(webApp.vars.logMsg),!1;for(var a=[],o=0;o<d.nodes.length;o++){var n=d.nodes[o];if(n.node_tags)for(var s=n.node_tags,l=0;l<s.length;l++){var i=t.tagName.trim();s[l].text.trim()===i&&a.push(n)}else console.log(n)}"function"==typeof t.callback&&t.callback(a)},search:function(e){var t={targetField:null,keyword:null,callback:null};for(var r in e)t[r]=e[r];var a,o=t.targetField;"title"===o&&(a="text");for(var n=[],s=0;s<d.nodes.length;s++){var l=d.nodes[s],i=l[o];if(i)if(a&&0<a.length){for(var c=0;c<i.length;c++)if(i[c][a]){var p=i[c][a].toLowerCase(),u=t.keyword.toLowerCase();if(-1!==p.indexOf(u)){n.push(l);break}}}else{if("string"!=typeof l[o])continue;p=l[o].toLowerCase(),u=t.keyword.toLowerCase();-1!==p.indexOf(u)&&n.push(l)}}d.queryRes=n,"function"==typeof t.callback&&t.callback(n)},sortNodes:function(e){var o={records:[],sortOrder:"asc",sortByKey:null};for(var t in e)o[t]=e[t];if(0===o.records.length){var r="error, not found sorting records...";return func.logAlert(r,"error"),console.log(r),!1}if(!o.sortByKey){r="error, not found 'sortByKey'...";return func.logAlert(r,"error"),console.log(r),!1}o.records.sort(function(e,t){var r,a;switch(r=e[o.sortByKey],a=t[o.sortByKey],"title"===o.sortByKey&&(r=e[o.sortByKey][0].text.toLowerCase(),a=t[o.sortByKey][0].text.toLowerCase()),"updated"===o.sortByKey&&(r=e.timestamp,a=t.timestamp),o.sortOrder){case"asc":return a<r?1:r<a?-1:0;case"desc":return a<r?-1:r<a?1:0}})}}}function _draw(e){var k={templates:{blockPlayer:'<div class="uk-card uk-card-default uk-margin-small">\t\t\t\t\t\t<div class="row">\t\t\t\t\t\t\t<div class="uk-float-right">\t\t\t\t\t\t\t\t\t<a data-toggle="#block-player" href="?q=close" class="uk-button uk-button-small uk-button-danger">x</a>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>\t\t\t\t\t\t<div class="uk-card-body w60 uk-padding-small wrapper">\t\t\t\t\t\t\t<div class="uk-margin-small">\t\t\t\t\t\t\t\t<h5 id="track-info"></h5><audio id="audio-player" controls="controls" class="w100"><source src="" />Tag <b>audio</b> not supported by this browser....</audio>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t<div class="uk-margin-small"><iframe type="text/html" id="iframe-player" src="" style="display: none;" width="640" height="385" frameborder="1"></iframe><video id="video-player" controls="controls" width="640" height="385">\t<source src="">\tTag <b>video</b> not supported by this browser.... </video>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t<div id="player-buttons">\t\t\t\t\t\t\t\t<ul class="button-group uk-list">\x3c!--<button id="btn-play" class="btn btn-blue">play</button><button id="btn-pause" class="btn btn-blue">pause</button>--\x3e<li><a href="?q=prev-track" class="btn btn-blue">previous track</a></li><li><a href="?q=next-track" class="btn btn-blue">next track</a></li>\t\t\t\t\t\t\t\t</ul>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>{{content}}\t\t\t\t\t</div>',blockTrackList:'<div class="wrapper">{{content}}</div>',trackList:'<div class="row">\t\t\t<div class="uk-float-left">\t\t\t\t<h4>{{tracklist_title}}</h4>\t\t\t</div>\t\t\t<div class="uk-float-right">\t\t\t\t\t<a data-toggle="#block-tracklist" href="?q=close" class="uk-button uk-button-small uk-button-danger">x</a>\t\t\t</div></div>\t\t<div class="">\t\t\t<ul class="menu-track-action button-group uk-list"><li><a href="?q=clear-tracklist" class="uk-button uk-button-danger uk-button-small">clear track list</a></li><li><a href="?q=toggle" data-toggle="#modal-insert-track" class="uk-button uk-button-primary uk-button-small">insert track</a></li><li><a href="?q=get-tracklist-url&action=load-tracklist" title="load track list from JSON file" class="uk-button uk-button-primary uk-button-small">Load track list</a></li><li><a href="?q=get-tracklist-url&action=save-tracklist" title="save track list to JSON file" class="uk-button uk-button-primary uk-button-small">Save track lists</a></li>\t\t\t</ul>\t\t</div><div class="media-list">\t<ul id="track-list" class="list-unstyled">{{list}}</ul></div>',trackListItem:'<li class="list-group-item">\t<div class="uk-clearfix">\t\t<div class="uk-float-left">{{number}}.\t\t\t<a class="track-name" href="?q=load-track&amp;num={{number}}">{{artist}}, {{title}}</a>\t\t</div>\t\t<div class="uk-float-right"><a class="edit-track" href="?q=edit-track&amp;num={{number}}">edit</a> | <a class="remove-track" href="?q=remove-track&amp;num={{number}}" title="Remove this track from tracklist">x</a>\t\t</div>\t</div></li>',blockTags:"{{block-tag-groups}} {{block-taglist}}",blockTagGroups:'\t\t\t\t\t\t<div class="uk-card uk-card-primary">\t\t\t\t\t\t<div class="row">\t\t\t\t\t\t\t<div class="uk-float-left uk-padding-small">\t\t\t\t\t\t\t\t<b>Tag groups</b>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t<div class="uk-float-right"><a data-toggle="#block-tags" href="?q=close" title="reset tags select" class="uk-button uk-button-small uk-button-danger">x</a>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>\t\t\t\t\t\t<div class="uk-card-body uk-padding-small">{{content}}\t\t\t\t\t\t</div>\t\t\t\t\t</div>',tagGroupsList:'<ul class="uk-list tag-list">{{list}}</ul>',tagGroupsListItem:'<li><a  href="?q=get-tag-list&vid={{vid}}&group_name={{name}}">{{name}} </a><small>({{num}})</small></li>',blockTagList:'\t\t\t\t\t\t<div class="uk-card uk-card-secondary collapse" id="tags-music-syles">\t\t\t\t\t\t\t<div class="uk-card-body uk-padding-small">{{content}}\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>',tagList:'<ul class="uk-list tag-list">{{list}}</ul>',tagListItem:'<li><a href="?q=get-nodes-by-tag&vid={{vid}}&tid={{tid}}&group_name={{group_name}}">{{text}} </a><small>({{num}})</small></li>',blockFileManager:'<div class="uk-card uk-card-default wrapper">{{content}}</div>',contentFileManager:'<div class="row">\t\t\t\t\t\t\t<div class="uk-float-left uk-padding-small">\t\t\t\t\t\t\t\t\t<b>File manager</b>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t<div class="uk-float-right"><a data-toggle="#fm-settings" href="?q=toggle" class="btn icon-cog"></a><a data-toggle="#block-file-manager" href="?q=close" class="uk-button uk-button-small uk-button-danger">x</a>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>\t\t\t\t\t\t<div class="uk-card-body uk-padding-small"><div id="fm-settings" class="wrapper uk-margin-small uk-padding-small uk-hidden"><b>Define location music collection: </b>\t<input name="inp_location_path" id="input-location-path" value="{{location}}" type="text" class="uk-input w80">\t<a href="?q=define-location" class="btn btn-blue">Reload</a>\t<p>/mnt/d2/music; /home/www/music; d:/music</p>\t<b>web alias:</b><input name="inp_web_alias" id="input-web-alias" value="{{web_alias}}" type="text" class="uk-input w60">\t<p>/music; /www; /video....</p></div>\t\t\t\t\t\t\t<div class="wrapper">{{buttons_fs_action}}<div class="row">\t{{btn_change_level}}\t<div class="breadcrumbs uk-float-left w90"><p><b>fs path</b>: {{fs_path}}</p> <p><b>url path</b>: {{url_path}}</p></div></div>{{filelist}}\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>',buttonsFSaction:'<div class="">\t<ul class="btn-fs-action button-group"><li><a href="?q=check-all" class="btn btn-blue">select all</a></li><li><a href="?q=clear-all" class="btn btn-blue">clear all</a></li><li><a href="?q=rename-file" class="btn btn-orange">rename selected</a></li><li><a href="?q=delete-file" class="group-remove uk-button uk-button-small uk-button-danger" >delete selected</a></li><li><a href="?q=add-track" class="uk-button uk-button-small uk-button-primary">add track to tracklist</a></li>\t</ul></div>',btnChangeLevel:'<div class="uk-padding-small uk-float-left"><a class="up-link icon-level-up" href="?q=level-up"></a></div>',fileList:'<div class="wfm">{{subfolders}}{{files}}</div>',subfolders_listTpl:'<ul class="folders-list uk-list uk-list-striped">{{list}}</ul>',subfolders_itemTpl:'<li><input name="file[]" value="{{name}}" type="checkbox" class="no-block-link"><a class="subfolder" href="?q=get-folder&foldername={{name}}"><span class="icon-folder"></span>{{name}}</a></li>',files_listTpl:'<ul class="files-list uk-list uk-list-striped">{{list}}</ul>',files_itemTpl:'<li><div>\t\t<input name="file[]" value="{{name}}" type="checkbox" class="no-block-link">\t\t<a class="file-name no-block-link" href="{{url}}" target="_blank">{{name}}</a>\t</div></li>',files_itemTpl_block:'<li>\t<div>\t\t<input name="file[]" value="{{name}}" type="checkbox" class="no-block-link">\t\t<span class="file-name">{{name}}</span>\t</div></li>',blockPager:'<div class="row"><div class="uk-float-left">records: <b><span id="total-records">{{total_nodes}}</span></b> (<small><b><span id="num-pages">{{num_pages}}</span></b> pages</small>)</div>\t\t\t\t\t\t\t<div class="uk-float-right"><form name="formSearch" id="form-search" action="">\t<div class="form-group">search by: \t\t<label><input type="radio" name="targetField" value="title" checked>title</label>\x3c!--\t\t<label><input type="radio" name="targetField" value="description">description</label> --\x3e\x3c!--\t\t<label><input type="radio" name="targetField" value="filename" >attached filename</label>--\x3e\t</div>\t<ul class="button-group">\t\t<li><input name="keyword" id="input-keyword" placeholder="enter keyword" autocomplete="off" value="" type="text" class="uk-input"></li>\t\t<li><button type="submit" class="uk-button uk-button-small uk-button-primary no-block-link"><i class="icon-search no-block-link"></i></button></li>\t\t<li><button type="reset" class="uk-button uk-button-small uk-button-danger no-block-link"><i class="icon-remove no-block-link"></i></button></li>\t</ul></form>\t\t\t\t\t\t\t</div>\t\t\t\t\t</div>\t\t\t\t\t<div class="row">\t\t\t\t\t\t<div class="block-num-page uk-float-left w20"><small>page №:</small><button id="btn-page-number-less" class="">-</button><input id="page-number" type="text" value="" size="3" maxlength="3" autocomplete="off" class="only-numbers"><button id="btn-page-number-more" class="">+</button>\t\t\t\t\t\t</div>\t\t\t\t\t\t<div class="uk-float-left w60 box-range"><input id="page-range" type="range" min="1" max="5" step="1" value="1" autocomplete="off" class="range uk-width-1-1">\t\t\t\t\t\t</div>\t\t\t\t\t</div>\t\t\t\t\t<div class="row">\t\t\t\t\t\t<div class="uk-float-right">\t\t\t\t\t\t\t<label class="uk-label">sort by</label>\t\t\t\t\t\t\t<select id="select-sort" class="" autocomplete="off">\t\t\t\t\t\t\t\t<option value="" selected=""></option>\t\t\t\t\t\t\t\t<option value="title">title</option>\t\t\t\t\t\t\t\t<option value="updated">update date</option>\t\t\t\t\t\t\t</select>\t\t\t\t\t\t</div>\t\t\t\t\t</div>',blockNodes:"{{content}}",blockList:"<div>{{list}}</div>",blockListItem:'<div class="uk-card uk-card-default node pls-8"><div class="node-wrap">\t\t\t\t\t\t<div class="uk-card-header uk-padding-small block-titles">{{title}}\t\t\t\t\t\t</div>\t\t\t\t\t\t<div class="uk-card-body uk-padding-small block-images">\t\t\t\t\t\t\t<img src="{{main_picture}}">\t\t\t\t\t\t</div></div>\t\t\t\t\t\t<div class="toggle-content">\t\t\t\t\t\t\t<button class="btn-dropdown icon-chevron-down"></button>\t\t\t\t\t\t\t<div class="uk-card-body uk-padding-small block-content">\t\t\t\t\t\t\t\t<ul class="uk-list"><li><a href="?q=load-tracklist&url={{playlist_filepath}}" class="btn btn-blue-c4 btn-load-tracklist">add to tracklist</a></li><li><a href="?q=edit-node&nid={{nid}}" class="btn btn-blue-c4">edit</a></li>\t\t\t\t\t\t\t\t</ul>{{related_links}}\t\t\t\t\t\t\t\t<div class="description">{{description}}</div>{{node_tags}}{{images}}\t\t\t\t\t\t\t\t<div>\t\t\t\t\t\t\t\t\t<small>published: {{published}},\tupdated: {{updated}}</small>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>\t\t\t</div>',title:{listTpl:"{{list}}",itemTpl:"<h3>{{text}}</h3>"},images:{listTpl:'<div class="uk-card-body uk-padding-small">{{list}}</div>',itemTpl:'<div class="block-images"><img src="{{src}}" alt="" title=""></div>'},related_links:{listTpl:'<ul class="related-links">{{list}}</ul>',itemTpl:'<li><a href="{{href}}" data-type="{{data-type}}" target="_blank" class="no-block-link">{{text}}</a></li>'},node_tags:{listTpl:'<div><ul class="list-inline node-tags">{{list}}</ul></div>',itemTpl:'<li><a href="?q=get-nodes-by-tag&group-name={{group_name}}" class="">{{text}}</a></li>'},blockFooterLinks:'\x3c!-- <h2>{{block_title}}</h2>--\x3e<div class="uk-card uk-card-primary">{{content}}</div>',blockLinksList:'<ul class="uk-card-body uk-text-center">{{list}}</ul>',blockLinksListItem:'<li class="uk-inline"><a class="no-block-link" href="{{url}}" target="_blank">{{title}}</a></li>'}},a=function(e){var r=new Date,a={title:"",content:"",templateID:"tpl-block",postFunc:function(){var e=(new Date).getTime()-r.getTime(),t="Generate block '"+this.title+"', "+this.templateID+", runtime:"+e/1e3+" sec";console.log(t),"function"==typeof a.callback&&a.callback()},callback:null};for(var t in e)a[t]=e[t];"function"==typeof a.content?a.content():o(a)},o=function(e){var t={templateID:!1,locationID:"",title:"block",content:!1,postFunc:null};for(var r in e)t[r]=e[r];var a=t.templateID;if(!webApp.draw.vars.templates[a])return webApp.vars.logMsg="_insertBlock(), error, not found template, id:"+a,func.logAlert(webApp.vars.logMsg,"error"),console.log("-- "+webApp.vars.logMsg),"function"==typeof t.callback&&t.callback(),!1;t.content&&0!==t.content.length||(webApp.vars.logMsg="_insertBlock(), warning, not found or empty content block "+t.locationID,console.log("-- "+webApp.vars.logMsg));var o=webApp.draw.vars.templates[a];o=(o=o.replace("{{block_title}}",t.title)).replace("{{content}}",t.content);var n=func.getById(t.locationID);n?(n.innerHTML=o,"none"===n.style.display&&(n.style.display="block")):(webApp.vars.logMsg="error, not found block location id: "+t.locationID,func.logAlert(webApp.vars.logMsg,"error"),console.log(webApp.vars.logMsg)),"function"==typeof t.postFunc&&t.postFunc()};function t(e){var v={data:null,templateID:!1,templateListItemID:!1};for(var t in e)v[t]=e[t];if(!v.data||0===v.data.length)return console.log("-- _draw.wrapData(), error, incorrect data ..."),!1;if(!v.templateID)return console.log("-- _draw.wrapData(), error, templateID was not defined..."),!1;if(!webApp.draw.vars.templates[v.templateID])return console.log("-- _draw.wrapData(),  error, not find template, id: "+v.templateID),!1;return(0<v.data.length?function(e,t){if(!(e instanceof Array))return console.log("-- error, info block data  is not instanceof Array: ",typeof e,e),!1;for(var r="",a=0;a<e.length;a++){var o=e[a],n=webApp.draw.vars.templates[v.templateListItemID];if(o.template&&0<o.template.length){var s=o.template;if(!webApp.draw.vars.templates[s]){console.log("-- warning, not found template, ",s);continue}n=webApp.draw.vars.templates[s]}for(var l=n.match(/{{(.*?)}}/g),i=0;i<l.length;i++)l[i]=l[i].replace("{{","").replace("}}","");var c=JSON.stringify(o),p=JSON.parse(c);for(i=0;i<l.length;i++){var u=l[i];if(o[u]instanceof Array)if(0===o[u].length)console.log("-- warning, empty field....",u,o[u]);else{for(var d=k.templates[u].listTpl,g=k.templates[u].itemTpl,b="",f=0;f<o[u].length;f++)b+=m(o[u][f],g);d=d.replace("{{list}}",b),p[u]=d}-1!==n.indexOf("{{"+u+"}}")&&(n=void 0===o[u]?n.replace(new RegExp("{{"+u+"}}","g"),""):n.replace(new RegExp("{{"+u+"}}","g"),p[u]))}r+=n}return t=t.replace("{{list}}",r)}:m)(v.data,webApp.draw.vars.templates[v.templateID]);function m(e,t){if(e.template&&0<e.template.length){var r=e.template;if(!webApp.draw.vars.templates[r])return"";t=webApp.draw.vars.templates[r]}var a=t;for(var o in e)-1!==a.indexOf("{{"+o+"}}")&&(a=a.replace(new RegExp("{{"+o+"}}","g"),e[o]));return a=a.replace(new RegExp(/{{(.*?)}}/g),"")}}return{vars:k,init:function(){},buildPage:function(e){var t={};for(var r in e)t[r]=e[r];a(webApp.vars.blocksByName.blockTagGroups),a(webApp.vars.blocksByName.blockPager),a(webApp.vars.blocksByName.blockNodes),a(webApp.vars.blocksByName.blockPlayer),a(webApp.vars.blocksByName.blockTrackList),webApp.vars.use_file_manager&&a(webApp.vars.blocksByName.blockFM),a(webApp.vars.blocksByName.blockFooterLinks)},buildBlock:a,insertBlock:function(e){return o(e)},wrapData:function(e){return t(e)},updatePager:function(e){if(0===webApp.db.vars.queryRes.length)var t=webApp.db.vars.nodes.length;else t=webApp.db.vars.queryRes.length;var r=Math.ceil(t/webApp.db.vars.numRecordsPerPage);webApp.db.vars.numPages=r,$("#total-records").text(t),$("#num-pages").text(r),$("#page-number").val(webApp.db.vars.numberPage),$("#page-range").val(webApp.db.vars.numberPage),$("#page-range").attr("max",webApp.db.vars.numPages)}}}function _fileManager(e){function t(t){if(i.fsPath=i.aliasLocation,i.urlPath=i.alias,!webApp.vars.support.promiseSupport)return i.supportPHP=!1,o(),"function"==typeof t.postFunc&&t.postFunc(),!1;new Promise(function(r,a){$.ajax({type:"GET",dataType:"json",url:i.testPHP_url,success:function(e,t){4===e.testResult?(i.supportPHP=!0,i.logMsg=t+", PHP script language supported by server, version "+e.version,func.logAlert(i.logMsg,"success")):o(),r()},error:function(e,t,r){console.log("-- errorThrown: ",r),i.supportPHP=!1,a()}})}).then(function(e){return i.fileListUrl="api/filelist.php",i.renameUrl="api/rename.php",i.removeUrl="api/remove.php",i.saveTrackListUrl="api/save_pls.php","function"==typeof t.postFunc&&t.postFunc(),!1},function(e){return o(),"function"==typeof t.postFunc&&t.postFunc(),!1})}var i={testPHP_url:"api/test.php",supportPHP:!1,alias:"/music",aliasLocation:"/mnt/d2/music",fsPath:""};function o(){webApp.vars.use_file_manager=!1,i.logMsg="PHP script language NOT supported by server.",func.logAlert(i.logMsg,"error")}function a(e){var a=$.Deferred(),t={dirName:!1};for(var r in e)t[r]=e[r];return 0===t.dirName.length&&(i.logMsg="-- warning, root level ...",console.log(i.logMsg),console.log(t),t.dirName="/"),t.dirName||(i.logMsg="-- error, incorrect input parameters....",console.log(i.logMsg),console.log(t),a.reject(!1)),$.ajax({type:"GET",dataType:"json",url:i.fileListUrl,data:{dir:t.dirName},success:function(e,t){if(e.eventType&&"error"===e.eventType&&(i.logMsg=e.message,func.logAlert(i.logMsg,"error"),a.reject(!1)),e.eventType&&"warning"===e.eventType&&(i.logMsg=e.message,func.logAlert(i.logMsg,"warning"),e.files=[{}]),e.subfolders||e.files){var r=function(e){var t="";e.subfolders&&(t=webApp.draw.wrapData({data:e.subfolders,templateID:"subfolders_listTpl",templateListItemID:"subfolders_itemTpl"}));var r="";if(e.files){i.urlPath=s(i.fsPath);for(var a=0;a<e.files.length;a++){var o=e.files[a];i.urlPath?o.url=i.urlPath+"/"+o.name:(o.url="#",o.template="files_itemTpl_block")}r=webApp.draw.wrapData({data:e.files,templateID:"files_listTpl",templateListItemID:"files_itemTpl"})}return webApp.draw.wrapData({data:{subfolders:t,files:r},templateID:"fileList"})}(e);a.resolve(r)}else a.reject(!1)},error:function(e,t,r){console.log("textStatus: "+t),console.log("-- errorThrown: "+r),i.logMsg="server request error....",i.logMsg+=", <b>textStatus</b>: "+t,i.logMsg+=", <b>errorThrown</b>: "+r,func.logAlert(i.logMsg,"error"),a.reject(!1)}}),a}function n(r){if(!webApp.vars.support.promiseSupport)return i.logMsg="error, window.Promise not supported...",func.logAlert(i.logMsg,"error"),"function"==typeof r.postFunc&&r.postFunc(),!1;a({dirName:i.fsPath}).then(function(e){_dataObj={web_alias:i.alias,location:i.aliasLocation,buttons_fs_action:webApp.draw.vars.templates.buttonsFSaction,btn_change_level:webApp.draw.vars.templates.btnChangeLevel,fs_path:i.fsPath,url_path:s(i.fsPath),filelist:e},0===i.fsPath.length&&(delete _dataObj.btn_change_level,_dataObj.fs_path="/");var t=webApp.draw.wrapData({data:_dataObj,templateID:"contentFileManager"});"function"==typeof r.postFunc&&r.postFunc(t)},function(e){console.log("-- THEN, promise rejected",e);var t=i.fsPath.substring(0,i.fsPath.lastIndexOf("/"));i.fsPath=t,"function"==typeof r.postFunc&&r.postFunc(e)})}function s(e){var t=e.indexOf(i.alias);return-1!==t&&e.substring(t,e.length)}function l(e){var t=e.split("/"),r=t.length-1;return-1!==t[r].indexOf(".")&&(r=t.length-2),t[r]}return{vars:i,init:function(e){return t(e)},getFileList:a,formHtmlFileManager:n,urlManager:function(e){switch(i.GET=func.parseGetParams(e),i.GET.q){case"get-folder":i.fsPath=i.fsPath+"/"+i.GET.foldername,n({postFunc:function(e){e&&0<e.length&&(webApp.vars.blocksByName.blockFM.content=e,webApp.draw.buildBlock(webApp.vars.blocksByName.blockFM))}});break;case"level-up":var t=i.fsPath.substring(0,i.fsPath.lastIndexOf("/"));i.fsPath=t,i.urlPath=s(i.fsPath),n({postFunc:function(e){e&&0<e.length&&(webApp.vars.blocksByName.blockFM.content=e,webApp.draw.buildBlock(webApp.vars.blocksByName.blockFM))}});break;case"define-location":var r=$("#input-location-path").val();if(!r||0===r.length)return!1;var a=$("#input-web-alias").val();_alias=i.alias,_alias_loc=i.aliasLocation,_fs_path=i.fsPath,i.aliasLocation=r.trim(),i.fsPath=i.aliasLocation,i.alias=a.trim(),n({postFunc:function(e){e&&0<e.length?(webApp.vars.blocksByName.blockFM.content=e,webApp.draw.buildBlock(webApp.vars.blocksByName.blockFM)):(i.alias=_alias,i.aliasLocation=_alias_loc,i.fsPath=_fs_path)}});break;case"check-all":$("#block-file-manager").find(".wfm input[type=checkbox]").each(function(e,t){$(t).prop("checked",!0)});break;case"clear-all":$("#block-file-manager").find(".wfm :checkbox:checked").each(function(e,t){$(t).prop("checked",!1)});break;case"delete-file":var o=[];if($("#block-file-manager").find(".wfm :checkbox:checked").each(function(e,t){o.push($(t).val())}),!webApp.vars.support.promiseSupport)return i.logMsg="error, window.Promise not supported...",func.logAlert(i.logMsg,"error"),!1;(function(e){var t={fsPath:!1,files:!1};for(var r in e)t[r]=e[r];if(!t.fsPath||0===t.fsPath.length)return i.logMsg="error, incorrect parameter fsPath...",console.log(i.logMsg),!1;if(!t.files||0===t.files.length)return i.logMsg="error, wrong parameter files...",console.log(i.logMsg),!1;var o={fs_path:t.fsPath,file:t.files};return new Promise(function(r,a){$.ajax({type:"POST",url:webApp.fileManager.vars.removeUrl,dataType:"json",data:o,success:function(e,t){e.eventType&&"error"===e.eventType&&(i.logMsg=e.message,func.logAlert(i.logMsg,"error"),a(!1)),e.eventType&&"success"===e.eventType&&(i.logMsg=e.message,func.logAlert(i.logMsg,"success"),n({postFunc:function(e){e&&0<e.length&&(webApp.vars.blocksByName.blockFM.content=e,webApp.draw.buildBlock(webApp.vars.blocksByName.blockFM))}}),r(e))},error:function(e,t,r){console.log("textStatus: "+t),console.log("errorThrown: "+r),i.logMsg="server request error....",i.logMsg+=", <b>textStatus</b>: "+t,i.logMsg+=", <b>errorThrown</b>: "+r,func.logAlert(i.logMsg,"error"),a(!1)}})})})({fsPath:i.fsPath,files:o}).then(function(e){},function(e){console.log("-- THEN, promise reject, ",e)});break;case"rename-file":$("#block-file-manager").find(".wfm :checkbox:checked").each(function(e,t){if(!webApp.vars.support.promiseSupport)return i.logMsg="error, window.Promise not supported...",func.logAlert(i.logMsg,"error"),!1;if(0===e){var r=i.fsPath+"/"+$(t).val();(function(e){var t={oldName:!1,newName:!1};for(var r in e)t[r]=e[r];if(console.log(t),!t.oldName||0===t.oldName.length)return i.logMsg="error, incorrect parameter oldName...",console.log(i.logMsg),!1;if(!t.newName||0===t.newName.length)return i.logMsg="error, wrong parameter newName...",console.log(i.logMsg),!1;var o={old_name:t.oldName,new_name:t.newName};return new Promise(function(r,a){$.ajax({type:"POST",url:webApp.fileManager.vars.renameUrl,dataType:"json",data:o,success:function(e,t){console.log(e),e.eventType&&"error"===e.eventType&&(i.logMsg=e.message,func.logAlert(i.logMsg,"error"),a(!1)),e.eventType&&"success"===e.eventType&&(i.logMsg=e.message,func.logAlert(i.logMsg,"success"),n({postFunc:function(e){e&&0<e.length&&(webApp.vars.blocksByName.blockFM.content=e,webApp.draw.buildBlock(webApp.vars.blocksByName.blockFM))}}),r(e))},error:function(e,t,r){console.log("textStatus: "+t),console.log("errorThrown: "+r),i.logMsg="server request error....",i.logMsg+=", <b>textStatus</b>: "+t,i.logMsg+=", <b>errorThrown</b>: "+r,func.logAlert(i.logMsg,"error"),a(!1)}})})})({fsPath:i.fsPath,oldName:r,newName:(a=r,window.prompt("rename/move file, enter new path/name:",a))}).then(function(e){console.log("-- THEN, promise resolve")},function(e){console.log("-- THEN, promise reject, ",e)})}else $(t).prop("checked",!1);var a});break;case"add-track":o=[];$("#block-file-manager").find(".files-list :checkbox:checked").each(function(e,t){var r=$(t).val();if(i.urlPath)if(function(e){var t=!1;for(var r in webApp.player.vars.mediaTypes){var a=webApp.player.vars.mediaTypes[r].extension;if(0<e.toLowerCase().lastIndexOf(a))return t=!0}return t}(r)){var a={artist:l(i.urlPath),title:r,source_url:i.urlPath+"/"+r};o.push(a)}else i.logMsg="- warning, could not add file "+r+" to tracklist, incorrect media type....",console.log(i.logMsg);else i.logMsg="- warning, could not add file "+r+" to tracklist, incorrect web-alias....",console.log(i.logMsg)}),$("#block-file-manager").find(".wfm :checkbox:checked").each(function(e,t){$(t).prop("checked",!1)}),0<o.length?function(e){var t={fileList:!1};for(var r in e)t[r]=e[r];if(!t.fileList||0===t.fileList.length)return i.logMsg="error, incorrect parameter fileList...",console.log(i.logMsg);for(var a=webApp.player.vars.trackFormat,o=[],n=0;n<t.fileList.length;n++){var s={};for(var r in a)s[r]="";var l=t.fileList[n];for(var r in s)s[r]=l[r];o.push(s)}webApp.player.formTrackList(o)}({fileList:o}):(i.logMsg="- warning, could not add selected files  to tracklist....",func.logAlert(i.logMsg,"warning"));break;default:console.log("-- fileManager.urlManager(),  GET query string: ",i.GET)}},getUrlPath:s,getFileType:function(e){var t=e.split("/"),r=t[t.length-1].split(".");return r[r.length-1]},getFileName:function(e,t){var r=e.split("/"),a=r[r.length-1];return t?a:a.split(".")[0]},getLastDirName:l}}function _player(e){var c={trackListName:"new_tracklist.json*",trackListTitle:"",trackList:[],trackFormat:{title:"Hit The Lights",artist:"Metallica",source_url:"/music/M/Metallica/1983_Kill_em_All/01_Hit_The_Lights.mp3"},numTrack:0,GET:{},mediaTypes:[{extension:"wav",testString:"audio/wav; codecs=1",support:!1},{extension:"ogg",testString:'audio/ogg; codecs="vorbis"',support:!1},{extension:"mp2,mpga,mpega",testString:"audio/x-mpeg",support:!1,name:"MPEG audio"},{extension:"mp3",testString:'audio/mpeg; codecs="mp3"',support:!1},{extension:"mp4,mpg4",testString:'audio/mp4; codecs="mp4a.40.5"',support:!1,name:"MPEG-4 audio"},{extension:"m4a",testString:"audio/x-m4a",support:!1,name:"MPEG-4 audio"},{extension:"wma",testString:"audio/x-ms-wma",support:!1,name:"Windows Media Audio"},{extension:"wma",testString:"audio/x-ms-wax",support:!1,name:"Windows Media Audio"},{extension:"3gp",testString:"audio/3gpp",support:!1},{extension:"flac",testString:"audio/flac",support:!1,name:"native FLAC format (FLAC in its own container)."},{extension:"ape",testString:"audio/ape",support:!1},{extension:"mka",testString:"audio/x-matroska",support:!1,name:"Matroska audio"},{extension:"ogg",testString:'video/ogg; codecs="theora, vorbis"',support:!1},{extension:"ogv",testString:"video/ogg",support:!1},{extension:"mp4",testString:'video/mp4; codecs="avc1.4D401E, mp4a.40.2"',support:!1,name:"MPEG-4 video"},{extension:"m4v",testString:"video/x-m4v",support:!1},{extension:"webm",testString:'video/webm; codecs="vp8.0, vorbis"',support:!1},{extension:"mpg",testString:"video/mpeg",support:!1,name:"MPEG-1"},{extension:"mpg,mpeg,mpe",testString:"video/x-mpeg",support:!1,name:"MPEG video"},{extension:"mov",testString:"video/quicktime",support:!1},{extension:"wmv",testString:"video/x-ms-wmv",support:!1,name:"Windows Media Video"},{extension:"3gp",testString:"video/3gpp",support:!1},{extension:"flv",testString:"video/x-flv",support:!1},{extension:"mkv",testString:"video/x-matroska",support:!1,name:"Matroska video"},{extension:"vob",testString:"video/x-ms-vob",support:!1},{extension:"avi",testString:"video/vnd.avi",support:!1},{extension:"avi",testString:"video/avi",support:!1},{extension:"avi",testString:"video/msvideo",support:!1},{extension:"avi",testString:"video/x-msvideo",support:!1}],playVideo:!1,playAudio:!1};function o(e){for(var t=0;t<e.length;t++)e[t].number=t+1,"mp3"in e[t]&&(e[t].source_url=e[t].mp3,delete e[t].mp3),e[t].source_url=e[t].source_url.replace(/%20/g," ");0<c.trackList.length?(c.trackList=c.trackList.concat(e),c.trackList.forEach(function(e,t,r){e.number=t+1})):(c.numTrack=0,c.trackList=e),webApp.draw.buildBlock(webApp.vars.blocksByName.blockTrackList),$("#block-player").is(":visible")||$("#block-player").show(),l({num:c.numTrack})}function n(){c.numTrack<c.trackList.length-1&&(c.numTrack++,l({num:c.numTrack}))}function l(e){var t={num:null,autoplay:!0};for(var r in e)t[r]=e[r];var a=parseInt(t.num);if(isNaN(a))return webApp.vars.logMsg="wrong activeNum: "+a,void console.log("-- error, "+webApp.vars.logMsg);var o=c.trackList[a];if(o){var n="";if(o.artist&&0<o.artist.length&&(n+=o.artist),o.title&&0<o.title.length&&(0<n.length&&(n+=", "),n+=o.title),0===n.length&&(o.mp3&&(n=o.mp3),o.source_url&&(n=o.source_url)),$("#track-info").text(n),o.mp3)var s=o.mp3;if(o.source_url)s=o.source_url;if(c.$audioplayer.pause(),c.$videoplayer.pause(),t.autoplay)if(function(e){for(var t=!1,r=webApp.fileManager.getFileType(e),a=0;a<c.mediaTypes.length;a++){var o=c.mediaTypes[a].testString,n=c.mediaTypes[a].extension,s=c.mediaTypes[a].support;if(r===n&&s){t=!0,-1!==o.indexOf("video")&&(c.$mediaplayer=c.$videoplayer),-1!==o.indexOf("audio")&&(c.$mediaplayer=c.$audioplayer);break}}return t}(s)){var l=encodeURI(s);console.log(l),$(c.$mediaplayer).attr("src",l),c.$mediaplayer.play()}else c.logMsg="Cannot play media file "+s,func.logAlert(c.logMsg,"error");var i=!1;$("#track-list a.track-name").each(function(e,t){$(this).removeClass("active"),e===a&&(i=t)}),i&&$(i).addClass("active")}else console.log("-- error, no track by activeNum = "+a)}return{vars:c,init:function(){return c.trackListTitle=c.trackListName,c.$audioplayer=func.getById("audio-player"),c.$videoplayer=func.getById("video-player"),c.$audioplayer.volume=.4,c.$videoplayer.volume=.4,$(c.$audioplayer).on("ended",function(e){console.log(e),n()}),$(c.$videoplayer).on("ended",function(e){console.log(e),n()}),$(c.$audioplayer).on("error",function(e){console.log(c.$audioplayer.error);var t=c.$audioplayer.error;t&&(webApp.vars.logMsg="MediaError, <b>code:</b> : "+t.code,webApp.vars.logMsg+=", <b>message:</b> : "+t.message,webApp.vars.logMsg+=", <b>src:</b> : "+c.$audioplayer.src,func.logAlert(webApp.vars.logMsg,"error"))}),$(c.$videoplayer).on("error",function(e){console.log(c.$videoplayer.error);var t=c.$videoplayer.error;t&&(webApp.vars.logMsg="<b>code:</b> : "+t.code,webApp.vars.logMsg+=", <b>message:</b> : "+t.message,webApp.vars.logMsg+=", <b>src:</b> : "+c.$videoplayer.src,func.logAlert(webApp.vars.logMsg,"error"))}),void(c.$mediaplayer=c.$audioplayer)},formHtmlTrackList:function(){if(0<c.trackList.length)var e=webApp.draw.wrapData({data:c.trackList,templateID:"trackList",templateListItemID:"trackListItem"});else e=webApp.draw.vars.templates.trackList.replace("{{list}}","");return c.unSavedTrackList?-1===c.trackListTitle.indexOf("*")&&(c.trackListTitle=c.trackListTitle+"*"):c.trackListTitle=c.trackListTitle.replace("*",""),e=e.replace("{{tracklist_title}}",c.trackListTitle)},formTrackList:o,urlManager:function e(t){switch(c.GET=func.parseGetParams(t),c.GET.q){case"get-tracklist-url":if("load-tracklist"===c.GET.action){var r=webApp.fileManager.vars.alias+"/0_playlists/"+c.trackListName.replace("*","");(a=window.prompt("Load track list, enter url:",r))&&0<a.length&&e("?q=load-tracklist&url="+a)}if("save-tracklist"===c.GET.action)if(0<c.trackList.length){var a;r=webApp.fileManager.vars.aliasLocation+"/0_playlists/"+c.trackListName.replace("*",""),(a=window.prompt("Save track list, enter file system path:",r))&&0<a.length&&e("?q=save-tracklist&fs_path="+a)}else webApp.vars.logMsg="warning, empty media track list ...",func.logAlert(webApp.vars.logMsg,"warning");break;case"load-tracklist":if(!c.GET.url||0===c.GET.url.length)return c.logMsg="error, not found tracklist url...",func.logAlert(c.logMsg,"error"),!1;if(!webApp.vars.support.promiseSupport)return c.logMsg="error, window.Promise not supported...",func.logAlert(c.logMsg,"error"),!1;(function(e){var t={trackListUrl:!1};for(var r in e)t[r]=e[r];var n=t.trackListUrl,s=new Promise(function(a,o){if(!n)return o("-- error, empty url....",n),s;$.getJSON(n,function(){}).done(function(e,t,r){webApp.vars.logMsg="server query done",webApp.vars.logMsg+=",  "+t+" load track list file <b>"+n+"</b>",func.logAlert(webApp.vars.logMsg,"success"),c.trackListTitle=n,a(e)}).fail(function(e,t,r){webApp.vars.logMsg="error, getJSON fail",webApp.vars.logMsg+=",  "+r+", "+n,func.logAlert(webApp.vars.logMsg,"error"),console.log(e),o(t)})});return s})({trackListUrl:c.GET.url}).then(function(e){o(e)},function(e){console.log("-- THEN, promise reject, ",e)});break;case"save-tracklist":if(!c.GET.fs_path||0===c.GET.fs_path.length)return c.logMsg="error, not found tracklist fs_path...",func.logAlert(c.logMsg,"error"),!1;if(!webApp.vars.support.promiseSupport)return c.logMsg="error, window.Promise not supported...",func.logAlert(c.logMsg,"error"),!1;(function(e){var o={trackListFsPath:!1};for(var t in e)o[t]=e[t];for(var r=c.trackFormat,a=[],n=0;n<c.trackList.length;n++){var s={};for(var t in r)s[t]="";var l=c.trackList[n];for(var t in s)s[t]=l[t];a.push(s)}console.log(a);var i={filename:o.trackListFsPath,playlist:a};return new Promise(function(r,a){$.ajax({type:"POST",url:webApp.fileManager.vars.saveTrackListUrl,dataType:"json",data:i,success:function(e,t){console.log(e),e.eventType&&"error"===e.eventType&&(c.logMsg=e.message,func.logAlert(c.logMsg,"error"),a(!1)),e.eventType&&"success"===e.eventType&&(webApp.vars.logMsg="server query done",webApp.vars.logMsg+=",  "+t+" save track list file <b>"+o.trackListFsPath+"</b>",func.logAlert(webApp.vars.logMsg,"success"),r(e))},error:function(e,t,r){console.log("textStatus: "+t),console.log("errorThrown: "+r),c.logMsg="server request error....",c.logMsg+=", <b>textStatus</b>: "+t,c.logMsg+=", <b>errorThrown</b>: "+r,func.logAlert(c.logMsg,"error"),a(!1)}})})})({trackListFsPath:c.GET.fs_path}).then(function(e){console.log("-- THEN, promise resolve"),c.unSavedTrackList=!1,c.trackListTitle=webApp.fileManager.getUrlPath(c.GET.fs_path),webApp.draw.buildBlock(webApp.vars.blocksByName.blockTrackList)},function(e){console.log("-- THEN, promise reject, ",e)});break;case"clear-tracklist":c.numTrack=0,c.trackList=[],c.trackListTitle=c.trackListName,webApp.draw.buildBlock(webApp.vars.blocksByName.blockTrackList);break;case"load-track":!function(e){var t={trackNum:!1};for(var r in e)t[r]=e[r];var a=t.trackNum-1;if(c.numTrack=a,!c.trackList[a])return webApp.vars.logMsg="not found track by num: "+a,console.log("-- "+webApp.vars.logMsg);var o=c.trackList[a];if(o.mp3)var n=o.mp3;o.source_url&&(n=o.source_url),c.$mediaplayer.setAttribute("src",n),l({num:c.numTrack})}({trackNum:c.GET.num});break;case"prev-track":0<c.numTrack&&(c.numTrack--,l({num:c.numTrack}));break;case"next-track":n();break;case"remove-track":!function(e){var t={trackNum:!1};for(var r in e)t[r]=e[r];var a=t.trackNum-1;delete c.trackList[a];var o=c.trackList.filter(function(e){return void 0!==e});o.forEach(function(e,t,r){e.number=t+1}),c.unSavedTrackList=!0,c.trackList=o,webApp.draw.buildBlock(webApp.vars.blocksByName.blockTrackList),l({num:c.numTrack,autoplay:!1})}({trackNum:c.GET.num});break;case"edit-track":!function(e){var t={trackNum:!1};for(var r in e)t[r]=e[r];var a=t.trackNum-1;console.log(a,c.trackList[a]),document.forms.form_insert_track.elements.input_title.value=c.trackList[a].title,document.forms.form_insert_track.elements.input_artist.value=c.trackList[a].artist,c.trackList[a].mp3&&0<c.trackList[a].mp3.length&&(document.forms.form_insert_track.elements.input_source_url.value=c.trackList[a].mp3),c.trackList[a].source_url&&0<c.trackList[a].source_url.length&&(document.forms.form_insert_track.elements.input_source_url.value=c.trackList[a].source_url),document.forms.form_insert_track.elements.number.value=c.trackList[a].number,webApp.app.toggleBlock("#modal-insert-track")}({trackNum:c.GET.num});break;case"insert-track":!function(e){var t={title:!1,artist:!1,source_url:!1};for(var r in e)t[r]=e[r];t.title||(t.title=webApp.fileManager.getFileName(t.source_url,!0)),t.artist||(t.artist=webApp.fileManager.getLastDirName(t.source_url));var a=c.trackFormat,o={};for(var r in a)o[r]="";var n=t;for(var r in o)o[r]=n[r];c.trackList.push(o);for(var s=0;s<c.trackList.length;s++)c.trackList[s].number=s+1;c.unSavedTrackList=!0,webApp.draw.buildBlock(webApp.vars.blocksByName.blockTrackList),$("#block-player").is(":visible")||$("#block-player").show(),c.numTrack=c.trackList.length-1,l({num:c.numTrack}),webApp.app.toggleBlock("#modal-insert-track")}({title:c.GET.input_title,artist:c.GET.input_artist,source_url:c.GET.input_source_url});break;case"update-track":!function(e){var t={number:!1,title:!1,artist:!1,source_url:!1};for(var r in e)t[r]=e[r];t.title||(t.title=webApp.fileManager.getFileName(t.source_url,!0)),t.artist||(t.artist=webApp.fileManager.getLastDirName(t.source_url));var a=c.trackFormat,o={};for(var r in a)o[r]="";var n=t;for(var r in o)o[r]=n[r];var s=n.number-1;c.trackList[s]=o;for(var l=0;l<c.trackList.length;l++)c.trackList[l].number=l+1;c.unSavedTrackList=!0,webApp.draw.buildBlock(webApp.vars.blocksByName.blockTrackList),webApp.app.toggleBlock("#modal-insert-track")}({number:c.GET.number,title:c.GET.input_title,artist:c.GET.input_artist,source_url:c.GET.input_source_url});break;default:console.log("-- player.urlManager(),  GET query string: ",c.GET)}},testMediaSupport:function(){var e=document.createElement("video");"object"==typeof e&&("function"!=typeof e.load?(c.logMsg="creating a object VIDEO failed.",func.logAlert(c.logMsg,"error")):c.playVideo=!0);var t=document.createElement("audio");function r(e){for(var t=0;t<c.mediaTypes.length;t++){var r=c.mediaTypes[t].testString,a=c.mediaTypes[t].extension,o="";c.mediaTypes[t].name&&(o="("+c.mediaTypes[t].name+")");var n=e.tagName.toLowerCase();if(-1!==r.indexOf(n)){var s=e.canPlayType(r);s&&0<s.length?(c.logMsg="test support media format <b>"+a+", "+o+"</b>, <i>"+r+"</i>: "+s,func.logAlert(c.logMsg,"success"),c.mediaTypes[t].support=!0):(c.logMsg="not support media format <b>"+a+", "+o+"</b>, <i>"+r+"</i>",func.logAlert(c.logMsg,"warning"))}}}"object"==typeof t&&("function"!=typeof t.load?(c.logMsg="creating a object AUDIO failed.",func.logAlert(c.logMsg,"error")):c.playAudio=!0),c.playAudio&&r(t),c.playVideo&&r(e)}}}console.log(webApp);