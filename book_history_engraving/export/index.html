<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>export</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="css/bootstrap336.min.css">
    </head>
<body>
<div class="container">

	<div class="page-header">
		<h1>export book history engraving</h1>
	</div>

<form name="form_export" id="export-form" action="include/export.php" method="POST" 
onSubmit="return validate();" target="_blank">

	<div class="text-center">
<!--	
		<input type="submit">
-->		
		<button type="submit" class="btn btn-large btn-primary">button submit</button>
	</div>

<legend>Параметры экспорта</legend>

<fieldset>
	<section class="panel panel-success">
		<div class="panel-heading">
			<h3>db connection type</h3>
		</div>
		
		<div class="row">
		
			<div class="col-md-6">
				<h3>MySQL</h3>
				<input type="radio" value="mysql" name="db_conn">
				
				<input type="text" name="mysqldb_host" class="form-control"  value="localhost" placeholder="enter mysql server name"/>
				<input type="text" name="mysqldb_user" class="form-control"  value="root" placeholder="enter user name"/>
				<input type="password" name="mysqldb_pwd" class="form-control"  placeholder="enter password"/>
				<input type="text" name="mysqldb_name" class="form-control"  placeholder="enter database name"/>
<pre>
art
gravura
mydb
photoalbum
webpad
wp
</pre>
			</div>
			
			<div class="col-md-6">
				<h3>SQLite</h3>
				<input type="radio" value="sqlite" name="db_conn" checked="checked">
				<input type="text" name="sqlite_path" class="form-control" 
id="sqlitedb-name" 
value="sqlite:/mnt/terra/clouds/Yandex.Disk/sync/sites/book_history_engraving/cms/db/gravura.sqlite"/>
			</div>
			
		</div>
		
	</section>
</fieldset>

<fieldset>
	<section class="panel panel-info">
		<div class="panel-heading">
			<h2>output format:</h2>
		</div>
		
<div class="form-group">
	<label class="radio-inline"><input type="radio" name="export[format]" checked="checked" value="html" >HTML pages</label>
	<label class="radio-inline"><input type="radio" name="export[format]" value="xml" >XML</label>
	<label class="radio-inline"><input type="radio" name="export[format]" value="json" >JSON</label>
	<label class="radio-inline"><input type="radio" name="export[format]" value="wxr" >WXR ( WordPress eXtended Rss export/import )</label>
</div>
	
	</section>
</fieldset>

<fieldset>
	<section class="panel panel-info">
		<div class="panel-heading">
			<h2>save data in:</h2>
		</div>
		
		<div class="col-md-6">
			<h3>File</h3>
			<input type="radio" value="file" name="export[savein]">
			<input type="text" name="export[filename]" class="form-control" value="">
			<pre>
export_gravura.xml
</pre>
		</div>
			
		<div class="col-md-6">
			<h3>Folder (export in html pages)</h3>
			<input type="radio" value="folder" name="export[savein]" checked="checked">
			
			<input type="text" name="export[foldername]" class="form-control" value="">
<pre>
/mnt/terra/clouds/Yandex.Disk/sync/sites/book_history_engraving/out
/mnt/disk2/temp/site.gravura
</pre>
			<label>page default template</label>
			<input type="text" name="export[html_tpl][page]" class="form-control" value="tpl/page.tpl.html">
			<label>picture template</label>
			<input type="text" name="export[html_tpl][picture]" class="form-control" value="tpl/picture.tpl.html">
		</div>
	
	</section>
</fieldset>

<div class="panel panel-success">
		<div class="panel-heading">
			<h3>Drupal book export parameters </h3>
		</div>
		
		<label>Book title:</label>
		<input type="text" name="export[drupal_book_to_page][book_title]" class="form-control" value="очерки истории и техники гравюры">
		
		<label>SQL queries:</label>
		<textarea rows="10" class="form-control" name="export[drupal_book_to_page][sql][get_nodes]">
-- получить страницы книги
SELECT 
	node.title, 
	page_title.page_title, -- заголовок HTML-страницы
	url_alias.alias, -- url страницы
	field_data_body.body_value as text, 
	node.nid --, 
	-- menu_links.plid, 
	-- node.created, 
	-- node.changed 
FROM book 
	LEFT JOIN menu_links ON menu_links.mlid=book.mlid 
	LEFT JOIN node ON node.nid=book.nid AND node.type="book"
	LEFT JOIN field_data_body ON field_data_body.entity_id=node.nid -- основная часть 
	LEFT JOIN page_title ON page_title.id=node.nid AND page_title.type="node" -- заголовок страницы
	LEFT JOIN url_alias ON url_alias.source='node/' || node.nid -- url страницы
WHERE book.mlid IN (
	-- получить menu_links.mlid всех страниц книги
	SELECT menu_links.mlid 
	FROM menu_links 
		LEFT JOIN book ON book.mlid=menu_links.mlid 
		LEFT JOIN node ON node.nid=book.nid
	WHERE 	menu_links.menu_name 
	IN (
		SELECT menu_name FROM menu_links WHERE link_title LIKE 'очерки истории и техники гравюры' AND module='book'
		) 
	AND node.type="book" ORDER BY weight ASC
) -- ORDER BY menu_links.weight, title ASC;
		</textarea>
		
		<textarea rows="10" class="form-control" name="export[drupal_book_to_page][sql][get_child_pictures]">
-- получить все страницы изображений, связанные со страницами книги
SELECT 
	-- menu_links.mlid,  
	-- menu_links.plid,
	book2.nid as parent_page_id,
	node.nid as picture_page_nid,
	-- node.title,
	field_data_field_content_files.field_content_files_value as filename,
	REPLACE( field_data_field_content_files.field_content_files_value, ".jpg", "") as file --,
	-- field_data_field_picture_info.field_picture_info_value as picture_info
FROM menu_links 
	LEFT JOIN book ON book.mlid=menu_links.mlid 
	LEFT JOIN node ON node.nid=book.nid
	LEFT JOIN book as book2 ON book2.mlid=menu_links.plid 
	LEFT JOIN field_data_field_content_files ON field_data_field_content_files.entity_id=node.nid
	-- LEFT JOIN field_data_field_picture_info ON field_data_field_picture_info.entity_id=node.nid
WHERE 	menu_links.menu_name 
IN (
	SELECT menu_name FROM menu_links WHERE link_title LIKE 'очерки истории и техники гравюры' AND module='book'
	) 
AND node.type="picture_page" 
		</textarea>
		
		<textarea rows="10" class="form-control" name="export[drupal_book_to_page][sql][get_child_pictures_info]">
-- получить данные об  изображениях
SELECT 
	entity_id as picture_page_nid,  
	-- delta,
	field_picture_info_value as picture_info
FROM field_data_field_picture_info 
		</textarea>
		
		<textarea rows="10" class="form-control" name="export[drupal_book_to_page][sql][get_child_pictures_termins]">
-- получить термины страниц изображений
SELECT 
	-- menu_links.mlid,  
	-- menu_links.plid,
	-- book2.nid as parent_page_id,
	node.nid as picture_page_nid,
	-- node.title,
	-- field_data_field_gallery_info.entity_id,
	-- field_data_field_gallery_info.field_gallery_info_tid as termin_id, 
	taxonomy_term_data.name as termin_name,
	-- taxonomy_term_data.description,
	field_data_field_termin_key.field_termin_key_value as termin_key,
	field_data_field_gallery_info_value.field_gallery_info_value_value as termin_value
FROM menu_links 
	LEFT JOIN book ON book.mlid=menu_links.mlid 
	LEFT JOIN node ON node.nid=book.nid
	LEFT JOIN book as book2 ON book2.mlid=menu_links.plid 
	LEFT JOIN field_data_field_gallery_info ON field_data_field_gallery_info.entity_id=node.nid
	LEFT JOIN taxonomy_term_data ON taxonomy_term_data.tid=field_data_field_gallery_info.field_gallery_info_tid
	LEFT JOIN field_data_field_gallery_info_value ON field_data_field_gallery_info_value.entity_id=taxonomy_term_data.tid
	LEFT JOIN field_data_field_termin_key ON field_data_field_termin_key.entity_id=taxonomy_term_data.tid
WHERE 	menu_links.menu_name 
IN (
	SELECT menu_name FROM menu_links WHERE link_title LIKE 'очерки истории и техники гравюры' AND module='book'
	) 
AND node.type="picture_page"
		</textarea>

		<pre name="export[drupal_book_to_page][sql][get_node_termins]">
-- получить связанные со страницей термины таксономии
SELECT 
	field_data_field_gallery_info.entity_id as node_id,
	-- field_data_field_gallery_info.entity_type,
	-- field_data_field_gallery_info.bundle,
	-- field_data_field_gallery_info.delta,
	field_data_field_gallery_info.field_gallery_info_tid as termin_id,
	taxonomy_term_data.name,
	field_data_field_gallery_info_value.field_gallery_info_value_value as value
FROM book 
LEFT JOIN menu_links ON menu_links.mlid=book.mlid 
LEFT JOIN node ON node.nid=book.nid
LEFT JOIN field_data_field_gallery_info ON field_data_field_gallery_info.entity_id=node.nid
LEFT JOIN taxonomy_term_data ON taxonomy_term_data.tid=field_data_field_gallery_info.field_gallery_info_tid
LEFT JOIN field_data_field_gallery_info_value ON field_data_field_gallery_info_value.entity_id=taxonomy_term_data.tid
WHERE 
	book.mlid IN (
		-- получить menu_links.mlid всех страниц книги
		SELECT menu_links.mlid 
		FROM menu_links 
		WHERE 	menu_links.menu_name 
		IN (
			SELECT menu_name FROM menu_links WHERE link_title LIKE 'очерки истории и техники гравюры' AND module='book'
			) ORDER BY weight ASC
	)
AND field_data_field_gallery_info.entity_id IS NOT NULL
-- ORDER BY field_data_field_gallery_info.delta ASC;
		</pre>
		
		<pre>
-- get_attach_pictures
-- получить параметры прикрепленных файлов
SELECT 
	book.nid,
	node.nid,
	field_data_field_content_files.field_content_files_value, 
	field_data_field_content_location.field_content_location_value,
	field_data_field_content_location.delta
FROM book 
	LEFT JOIN menu_links ON menu_links.mlid=book.mlid 
	LEFT JOIN node ON node.nid=book.nid
	LEFT JOIN field_data_field_content_files ON field_data_field_content_files.entity_id=node.nid
	LEFT JOIN field_data_field_content_location ON field_data_field_content_location.entity_id=node.nid AND field_data_field_content_location.delta IN (1 )
WHERE 
	book.mlid IN (
		-- получить menu_links.mlid всех страниц книги
		SELECT menu_links.mlid 
		FROM menu_links 
		WHERE 	menu_links.menu_name 
		IN (
			SELECT menu_name FROM menu_links WHERE link_title LIKE 'очерки истории и техники гравюры' AND module='book'
			) ORDER BY weight ASC
	)
		</pre>
		
</div>
	
</form>

</div><!-- end container -->

</body>
</html>
