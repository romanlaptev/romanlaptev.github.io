function _player(a){function b(a){switch(q.GET=func.parseGetParams(a),q.GET.q){case"get-tracklist-url":if("load-tracklist"===q.GET.action){var d=webApp.fileManager.vars.alias+"/0_playlists/"+q.trackListName.replace("*",""),j=window.prompt("Load track list, enter url:",d);if(j&&j.length>0){var o="?q=load-tracklist&url="+j;b(o)}}if("save-tracklist"===q.GET.action)if(q.trackList.length>0){var d=webApp.fileManager.vars.aliasLocation+"/0_playlists/"+q.trackListName.replace("*",""),j=window.prompt("Save track list, enter file system path:",d);if(j&&j.length>0){var o="?q=save-tracklist&fs_path="+j;b(o)}}else webApp.vars.logMsg="warning, empty media track list ...",func.logAlert(webApp.vars.logMsg,"warning");break;case"load-tracklist":if(!q.GET.url||0===q.GET.url.length)return q.logMsg="error, not found tracklist url...",func.logAlert(q.logMsg,"error"),!1;if(!webApp.vars.support.promiseSupport)return q.logMsg="error, window.Promise not supported...",func.logAlert(q.logMsg,"error"),!1;c({trackListUrl:q.GET.url}).then(function(a){e(a)},function(a){console.log("-- THEN, promise reject, ",a)});break;case"save-tracklist":if(!q.GET.fs_path||0===q.GET.fs_path.length)return q.logMsg="error, not found tracklist fs_path...",func.logAlert(q.logMsg,"error"),!1;if(!webApp.vars.support.promiseSupport)return q.logMsg="error, window.Promise not supported...",func.logAlert(q.logMsg,"error"),!1;f({trackListFsPath:q.GET.fs_path}).then(function(a){console.log("-- THEN, promise resolve"),q.unSavedTrackList=!1,q.trackListTitle=webApp.fileManager.getUrlPath(q.GET.fs_path),webApp.draw.buildBlock(webApp.vars.blocksByName.blockTrackList)},function(a){console.log("-- THEN, promise reject, ",a)});break;case"clear-tracklist":q.numTrack=0,q.trackList=[],q.trackListTitle=q.trackListName,webApp.draw.buildBlock(webApp.vars.blocksByName.blockTrackList);break;case"load-track":g({trackNum:q.GET.num});break;case"prev-track":i();break;case"next-track":h();break;case"remove-track":k({trackNum:q.GET.num});break;case"edit-track":l({trackNum:q.GET.num});break;case"insert-track":m({title:q.GET.input_title,artist:q.GET.input_artist,source_url:q.GET.input_source_url});break;case"update-track":n({number:q.GET.number,title:q.GET.input_title,artist:q.GET.input_artist,source_url:q.GET.input_source_url});break;default:console.log("-- player.urlManager(),  GET query string: ",q.GET)}}function c(a){var b={trackListUrl:!1};for(var c in a)b[c]=a[c];var d=b.trackListUrl,e=new Promise(function(a,b){if(!d)return b("-- error, empty url....",d),e;$.getJSON(d,function(){}).done(function(b,c,e){webApp.vars.logMsg="server query done",webApp.vars.logMsg+=",  "+c+" load track list file <b>"+d+"</b>",func.logAlert(webApp.vars.logMsg,"success"),q.trackListTitle=d,a(b)}).fail(function(a,c,e){webApp.vars.logMsg="error, getJSON fail",webApp.vars.logMsg+=",  "+e+", "+d,func.logAlert(webApp.vars.logMsg,"error"),console.log(a),b(c)})});return e}function d(){if(q.trackList.length>0)var a=webApp.draw.wrapData({data:q.trackList,templateID:"trackList",templateListItemID:"trackListItem"});else var a=webApp.draw.vars.templates.trackList.replace("{{list}}","");return q.unSavedTrackList?-1===q.trackListTitle.indexOf("*")&&(q.trackListTitle=q.trackListTitle+"*"):q.trackListTitle=q.trackListTitle.replace("*",""),a=a.replace("{{tracklist_title}}",q.trackListTitle)}function e(a){for(var b=0;b<a.length;b++)a[b].number=b+1,"mp3"in a[b]&&(a[b].source_url=a[b].mp3,delete a[b].mp3),a[b].source_url=a[b].source_url.replace(/%20/g," ");q.trackList.length>0?(q.trackList=q.trackList.concat(a),q.trackList.forEach(function(a,b,c){a.number=b+1})):(q.numTrack=0,q.trackList=a),webApp.draw.buildBlock(webApp.vars.blocksByName.blockTrackList),$("#block-player").is(":visible")||$("#block-player").show(),j({num:q.numTrack})}function f(a){var b={trackListFsPath:!1};for(var c in a)b[c]=a[c];for(var d=q.trackFormat,e=[],f=0;f<q.trackList.length;f++){var g={};for(var c in d)g[c]="";var h=q.trackList[f];for(var c in g)g[c]=h[c];e.push(g)}console.log(e);var i={filename:b.trackListFsPath,playlist:e};return new Promise(function(a,c){$.ajax({type:"POST",url:webApp.fileManager.vars.saveTrackListUrl,dataType:"json",data:i,success:function(d,e){console.log(d),d.eventType&&"error"===d.eventType&&(q.logMsg=d.message,func.logAlert(q.logMsg,"error"),c(!1)),d.eventType&&"success"===d.eventType&&(webApp.vars.logMsg="server query done",webApp.vars.logMsg+=",  "+e+" save track list file <b>"+b.trackListFsPath+"</b>",func.logAlert(webApp.vars.logMsg,"success"),a(d))},error:function(a,b,d){console.log("textStatus: "+b),console.log("errorThrown: "+d),q.logMsg="server request error....",q.logMsg+=", <b>textStatus</b>: "+b,q.logMsg+=", <b>errorThrown</b>: "+d,func.logAlert(q.logMsg,"error"),c(!1)}})})}function g(a){var b={trackNum:!1};for(var c in a)b[c]=a[c];var d=b.trackNum-1;if(q.numTrack=d,!q.trackList[d])return webApp.vars.logMsg="not found track by num: "+d,console.log("-- "+webApp.vars.logMsg),!1;var e=q.trackList[d];if(e.mp3)var f=e.mp3;if(e.source_url)var f=e.source_url;q.$mediaplayer.setAttribute("src",f),j({num:q.numTrack})}function h(){q.numTrack<q.trackList.length-1&&(q.numTrack++,j({num:q.numTrack}))}function i(){q.numTrack>0&&(q.numTrack--,j({num:q.numTrack}))}function j(a){var b={num:null,autoplay:!0};for(var c in a)b[c]=a[c];var d=parseInt(b.num);if(isNaN(d))return webApp.vars.logMsg="wrong activeNum: "+d,console.log("-- error, "+webApp.vars.logMsg),!1;var e=q.trackList[d];if(!e)return console.log("-- error, no track by activeNum = "+d),!1;var f="";if(e.artist&&e.artist.length>0&&(f+=e.artist),e.title&&e.title.length>0&&(f.length>0&&(f+=", "),f+=e.title),0===f.length&&(e.mp3&&(f=e.mp3),e.source_url&&(f=e.source_url)),$("#track-info").text(f),e.mp3)var g=e.mp3;if(e.source_url)var g=e.source_url;if(q.$audioplayer.pause(),q.$videoplayer.pause(),b.autoplay){if(p(g)){var h=encodeURI(g);console.log(h),$(q.$mediaplayer).attr("src",h),q.$mediaplayer.play()}else q.logMsg="Cannot play media file "+g,func.logAlert(q.logMsg,"error")}var i=!1;$("#track-list a.track-name").each(function(a,b){$(this).removeClass("active"),a===d&&(i=b)}),i&&$(i).addClass("active")}function k(a){var b={trackNum:!1};for(var c in a)b[c]=a[c];var d=b.trackNum-1;delete q.trackList[d];var e=q.trackList.filter(function(a){return void 0!==a});e.forEach(function(a,b,c){a.number=b+1}),q.unSavedTrackList=!0,q.trackList=e,webApp.draw.buildBlock(webApp.vars.blocksByName.blockTrackList),j({num:q.numTrack,autoplay:!1})}function l(a){var b={trackNum:!1};for(var c in a)b[c]=a[c];var d=b.trackNum-1;console.log(d,q.trackList[d]),document.forms.form_insert_track.elements.input_title.value=q.trackList[d].title,document.forms.form_insert_track.elements.input_artist.value=q.trackList[d].artist,q.trackList[d].mp3&&q.trackList[d].mp3.length>0&&(document.forms.form_insert_track.elements.input_source_url.value=q.trackList[d].mp3),q.trackList[d].source_url&&q.trackList[d].source_url.length>0&&(document.forms.form_insert_track.elements.input_source_url.value=q.trackList[d].source_url),document.forms.form_insert_track.elements.number.value=q.trackList[d].number,webApp.app.toggleBlock("#modal-insert-track")}function m(a){var b={title:!1,artist:!1,source_url:!1};for(var c in a)b[c]=a[c];b.title||(b.title=webApp.fileManager.getFileName(b.source_url,!0)),b.artist||(b.artist=webApp.fileManager.getLastDirName(b.source_url));var d=q.trackFormat,e={};for(var c in d)e[c]="";var f=b;for(var c in e)e[c]=f[c];q.trackList.push(e);for(var g=0;g<q.trackList.length;g++)q.trackList[g].number=g+1;q.unSavedTrackList=!0,webApp.draw.buildBlock(webApp.vars.blocksByName.blockTrackList),$("#block-player").is(":visible")||$("#block-player").show(),q.numTrack=q.trackList.length-1,j({num:q.numTrack}),webApp.app.toggleBlock("#modal-insert-track")}function n(a){var b={number:!1,title:!1,artist:!1,source_url:!1};for(var c in a)b[c]=a[c];b.title||(b.title=webApp.fileManager.getFileName(b.source_url,!0)),b.artist||(b.artist=webApp.fileManager.getLastDirName(b.source_url));var d=q.trackFormat,e={};for(var c in d)e[c]="";var f=b;for(var c in e)e[c]=f[c];var g=f.number-1;q.trackList[g]=e;for(var h=0;h<q.trackList.length;h++)q.trackList[h].number=h+1;q.unSavedTrackList=!0,webApp.draw.buildBlock(webApp.vars.blocksByName.blockTrackList),webApp.app.toggleBlock("#modal-insert-track")}function o(){function a(a){for(var b=0;b<q.mediaTypes.length;b++){var c=q.mediaTypes[b].testString,d=q.mediaTypes[b].extension,e="";q.mediaTypes[b].name&&(e="("+q.mediaTypes[b].name+")");var f=a.tagName.toLowerCase();if(-1!==c.indexOf(f)){var g=a.canPlayType(c);g&&g.length>0?(q.logMsg="test support media format <b>"+d+", "+e+"</b>, <i>"+c+"</i>: "+g,func.logAlert(q.logMsg,"success"),q.mediaTypes[b].support=!0):(q.logMsg="not support media format <b>"+d+", "+e+"</b>, <i>"+c+"</i>",func.logAlert(q.logMsg,"warning"))}}}var b=document.createElement("video");"object"==typeof b&&("function"!=typeof b.load?(q.logMsg="creating a object VIDEO failed.",func.logAlert(q.logMsg,"error")):q.playVideo=!0);var c=document.createElement("audio");"object"==typeof c&&("function"!=typeof c.load?(q.logMsg="creating a object AUDIO failed.",func.logAlert(q.logMsg,"error")):q.playAudio=!0),q.playAudio&&a(c),q.playVideo&&a(b)}function p(a){for(var b=!1,c=webApp.fileManager.getFileType(a),d=0;d<q.mediaTypes.length;d++){var e=q.mediaTypes[d].testString,f=q.mediaTypes[d].extension,g=q.mediaTypes[d].support;if(c===f&&g){b=!0,-1!==e.indexOf("video")&&(q.$mediaplayer=q.$videoplayer),-1!==e.indexOf("audio")&&(q.$mediaplayer=q.$audioplayer);break}}return b}var q={trackListName:"new_tracklist.json*",trackListTitle:"",trackList:[],trackFormat:{title:"Hit The Lights",artist:"Metallica",source_url:"/music/M/Metallica/1983_Kill_em_All/01_Hit_The_Lights.mp3"},numTrack:0,GET:{},mediaTypes:[{extension:"wav",testString:"audio/wav; codecs=1",support:!1},{extension:"ogg",testString:'audio/ogg; codecs="vorbis"',support:!1},{extension:"mp2,mpga,mpega",testString:"audio/x-mpeg",support:!1,name:"MPEG audio"},{extension:"mp3",testString:'audio/mpeg; codecs="mp3"',support:!1},{extension:"mp4,mpg4",testString:'audio/mp4; codecs="mp4a.40.5"',support:!1,name:"MPEG-4 audio"},{extension:"m4a",testString:"audio/x-m4a",support:!1,name:"MPEG-4 audio"},{extension:"wma",testString:"audio/x-ms-wma",support:!1,name:"Windows Media Audio"},{extension:"wma",testString:"audio/x-ms-wax",support:!1,name:"Windows Media Audio"},{extension:"3gp",testString:"audio/3gpp",support:!1},{extension:"flac",testString:"audio/flac",support:!1,name:"native FLAC format (FLAC in its own container)."},{extension:"ape",testString:"audio/ape",support:!1},{extension:"mka",testString:"audio/x-matroska",support:!1,name:"Matroska audio"},{extension:"ogg",testString:'video/ogg; codecs="theora, vorbis"',support:!1},{extension:"ogv",testString:"video/ogg",support:!1},{extension:"mp4",testString:'video/mp4; codecs="avc1.4D401E, mp4a.40.2"',support:!1,name:"MPEG-4 video"},{extension:"m4v",testString:"video/x-m4v",support:!1},{extension:"webm",testString:'video/webm; codecs="vp8.0, vorbis"',support:!1},{extension:"mpg",testString:"video/mpeg",support:!1,name:"MPEG-1"},{extension:"mpg,mpeg,mpe",testString:"video/x-mpeg",support:!1,name:"MPEG video"},{extension:"mov",testString:"video/quicktime",support:!1},{extension:"wmv",testString:"video/x-ms-wmv",support:!1,name:"Windows Media Video"},{extension:"3gp",testString:"video/3gpp",support:!1},{extension:"flv",testString:"video/x-flv",support:!1},{extension:"mkv",testString:"video/x-matroska",support:!1,name:"Matroska video"},{extension:"vob",testString:"video/x-ms-vob",support:!1},{extension:"avi",testString:"video/vnd.avi",support:!1},{extension:"avi",testString:"video/avi",support:!1},{extension:"avi",testString:"video/msvideo",support:!1},{extension:"avi",testString:"video/x-msvideo",support:!1}],playVideo:!1,playAudio:!1},r=function(a){q.trackListTitle=q.trackListName,q.$audioplayer=func.getById("audio-player"),q.$videoplayer=func.getById("video-player"),q.$audioplayer.volume=.4,q.$videoplayer.volume=.4,$(q.$audioplayer).on("ended",function(a){console.log(a),h()}),$(q.$videoplayer).on("ended",function(a){console.log(a),h()}),$(q.$audioplayer).on("error",function(a){console.log(q.$audioplayer.error);var b=q.$audioplayer.error;b&&(webApp.vars.logMsg="MediaError, <b>code:</b> : "+b.code,webApp.vars.logMsg+=", <b>message:</b> : "+b.message,webApp.vars.logMsg+=", <b>src:</b> : "+q.$audioplayer.src,func.logAlert(webApp.vars.logMsg,"error"))}),$(q.$videoplayer).on("error",function(a){console.log(q.$videoplayer.error);var b=q.$videoplayer.error;b&&(webApp.vars.logMsg="<b>code:</b> : "+b.code,webApp.vars.logMsg+=", <b>message:</b> : "+b.message,webApp.vars.logMsg+=", <b>src:</b> : "+q.$videoplayer.src,func.logAlert(webApp.vars.logMsg,"error"))}),q.$mediaplayer=q.$audioplayer};return{vars:q,init:function(){return r()},formHtmlTrackList:d,formTrackList:e,urlManager:b,testMediaSupport:o}}