<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>test Promise</title>
<!--	
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
-->
	<link rel="stylesheet" href="../css/bootstrap335.min.css">
	<script src="lib/jquery.min.js"></script>
</head>

<body>


	<div class="container">
	
		<div class="panel panel-primary">
			<div class="panel-heading">
				<h1>Promise info</h1>
			</div>
			
			<div class="panel-body">
<pre>
https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Global_Objects/Promise
https://learn.javascript.ru/promise		
https://www.sitepoint.com/overview-javascript-promises/
</pre>
				<button id="btn-test-promise" class="btn btn-primary">test Promise. Load test JSON</button>
			</div>
			
		</div>
	
		<div class="panel panel-primary">
			<div class="panel-heading">
				<h1>Async info</h1>
			</div>
			
			<div class="panel-body">
<pre>
Node.js >= 7.6
https://caniuse.com/#feat=async-functions

https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Statements/async_function
https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Operators/await

https://habrahabr.ru/company/ruvds/blog/326074/
Async/await: 6 причин забыть о промисах

https://medium.com/@derzunov/%D0%B7%D0%B0%D1%87%D0%B5%D0%BC-%D0%BC%D0%BD%D0%B5-async-await-%D0%B2-javascript-fb0eadf46f35
Зачем мне async/await в JavaScript?
</pre>
				<button id="btn-test-async" class="btn btn-warning">Test async/await. Load test JSON</button>
			</div>
			
		</div>
		
		<input type="text" class="form-control" id="request-url" value="test_json/data.json"/>
		
		<div id="log-wrap" class="panel panel-default log-panel">
			<div class="panel-heading">
				<h3>Log panel</h3>
			</div>
			<div class="panel-body" id="log"></div>
		</div>		
		
	</div><!-- end container -->

</body>

<script>
//https://medium.com/@derzunov/%D0%B7%D0%B0%D1%87%D0%B5%D0%BC-%D0%BC%D0%BD%D0%B5-async-await-%D0%B2-javascript-fb0eadf46f35
function asyncFunc1 () {
	return new Promise(function(resolve, reject) {
	
		setTimeout(function(){
			resolve({message: "First done!"}), 300 
			});
		
	});
};

function asyncFunc2 () {
	return new Promise(function(resolve, reject) {
	setTimeout( () => resolve({message: "Second done!"}), 200 );
	});
};

function asyncFunc3 () {
	return new Promise(function(resolve, reject) {
	setTimeout( () => resolve({message: "Third done!"}), 100 );
	});
};

function start () {// Работают асинхронно
  asyncFunc1().then(callback);
  asyncFunc2().then(callback);
  asyncFunc3().then(callback);
};
function callback ( data ) { console.log( data.message ) };

//----------------------- Use Promises callback
function startChain() {
	asyncFunc1()
	.then(
		function( data ) {
console.log(data.message );
			return asyncFunc2();
		}
	).then(
		function(data_2) {
console.log(data_2.message);
			return asyncFunc3();
			}
	).then( 
		function(data_3) {
console.log(data_3.message);
console.log("All done..");
		}
	);
};

//-----------------------
// Use async attribute
async function startAsyncAwait(){// Работают синхронно, в нужном нам порядке
	let data1 = await asyncFunc1();
	let data2 = await asyncFunc2();
	let data3 = await asyncFunc3();
console.log("startAsync:", data1.message, data2.message, data3.message);
};


//start();
//startChain();
startAsyncAwait();
//console.log( startAsyncAwait.constructor.name );

</script>

<script>
window.onload = function(){
	//let btn_load = document.querySelector("#btn-load");
	//btn_load.onclick = function(e){
//console.log("Click!!!", e);
	//}//end event
}//end load

if( typeof window.jQuery === "function"){
var msg = 'You are running jQuery version: ' + jQuery.fn.jquery;
console.log(msg);
	$(document).ready(function(){

		$("#btn-test-promise").on("click", function(e){
			log.innerHTML += "<p>- start load</p>";
			loadJson().then(
				function( data ){
//console.log("success: ",  arguments );			
					log.innerHTML += "<p>"+ JSON.stringify(data)+"</p>";
					log.innerHTML += "<p>- end load</p>";
				}, 
				function( error_msg ){
//console.log("fail: ",  arguments );			
					log.innerHTML += "<p>"+ error_msg +"</p>";
					log.innerHTML += "<p>- end load</p>";
				}
			);
		});
		
		$("#btn-test-async").on("click", function(e){
			Demo();
		});
		
	});//end ready	
}

async function Demo(){
	log.innerHTML += "<p>- start load</p>";

	try{
		let data = await loadJson();
//console.log( data );
		log.innerHTML += "<p>"+ JSON.stringify(data)+"</p>";
	} catch( e) {
console.log(e);	
		log.innerHTML += "<p>"+ e +"</p>";
	}
	
	log.innerHTML += "<p>- end load</p>";
}//end Demo()

function loadJson(){
	//let url = "test_json/dta.json";
	let url = $("#request-url").val();
/*
	$.getJSON( url, function( data ){
console.log( data );
		//let msg = "<p>Load data from "+ url +"</p>";
		//log.innerHTML += msg;
		//msg = JSON.stringify(data);
		//log.innerHTML += msg;
	});
*/		
	return new Promise( function(resolve, reject) {
		$.getJSON( url, function( data ){
//console.log( data );
		})
.done(function( data ) { 
	resolve( data ); 
})
.fail(function( xhr, status, description ) { 
console.log(arguments); 
	reject( url +", getJSON request failed! " + status +", "+description); 
})
.always(function() {  
});		

	});
	
}//end loadJson()
</script>

</html>